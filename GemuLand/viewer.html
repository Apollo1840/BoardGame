<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <title>å¡ç‰Œç”Ÿæˆå™¨</title>
    <style>
        /* æ‰“å°ä¿çœŸ */
        img, .content-box, .card-title { print-color-adjust: exact; }
        body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
        #card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(63mm,1fr)); gap:10px; justify-items:left; align-items:start; justify-content:start; align-content:start; }

        /* å¡ç‰ŒåŸºåº§ */
        .card {
            position: relative;
            width: 63mm;
            height: 88mm;
            border: 2px solid #000;
            border-radius: 8px;
            overflow: hidden;
            page-break-inside: avoid;
            -webkit-print-color-adjust: exact;   /* æ—§ç‰ˆ Chromiumã€Safari */
            print-color-adjust: exact;           /* æ–°æ ‡å‡†å†™æ³• */
        }

        /* åˆ†ç±»åº•è‰² */
        .card.monster  { background:#ffffff; }   /* çº¯ç™½è‰² */
        .card.prophecy {
            position: relative;
            background: none;
        }
        .card.prophecy::before {
            content: '';
            position: absolute;
            inset: 0;
            z-index: 0;
            background-image: var(--prophecy-bg, none);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            filter: blur(12px) brightness(0.7) saturate(1.2);
            border-radius: 8px;
            transition: background-image 0.3s;
        }
        .card.prophecy .card-image-container {
            position: absolute;
            top: 24px;
            left: 4px;
            right: 4px;
            bottom: calc(4px + 29.33mm);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            overflow: hidden;
        }
        .card.prophecy .card-content {
            position: absolute;
            bottom: calc(4px + 16px);
            left: 4px;
            right: 4px;
            height: calc(50% - 4px - 16px);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            gap: 2px;
            overflow: hidden;
            z-index: 3;
            font-size: 10px;
        }
        .card.prophecy .card-title {
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(10,30,80,0.5) !important;
            border-radius: 4px;
            padding: 2px 4px;
            font-weight: bold;
            font-size: 12px;
            z-index: 3;
            color: #fff !important;
        }

        /* é¢„è¨€å¡æ–‡æœ¬æ¡†æ·±è“åŠé€æ˜åº•ç™½å­— */
        .card.prophecy .content-box {
            background: rgba(10,30,80,0.5) !important;
            color: #fff !important;
            border-color: rgba(255,255,255,0.2) !important;
        }
        .card.prophecy .box-title,
        .card.prophecy .box-content {
            color: #fff !important;
        }
        /* å“åº”æ•ˆæœæ ‡é¢˜ä¾ç„¶ä¸ºçº¢è‰² */
        .card.prophecy .responsive-effect .box-title {
            color: red !important;
        }
        .card.prophecy .card-title {
            background: rgba(10,30,80,0.5) !important;
            color: #fff !important;
        }

        /* æ ‡é¢˜æ  */
        .card-title { position:absolute; top:4px; left:4px; right:4px; display:flex; justify-content:space-between; align-items:center;
            background:rgba(255,255,255,0.9); border-radius:4px; padding:2px 4px; font-weight:bold; font-size:12px; z-index:3; }
        .card-title .level, .card-title .type { font-size:11px; width:15%; text-align:center; }
        .card-title .name { font-size:12px; flex:1; text-align:center; }
        .prophecy .card-title { justify-content:center; }

        /* å›¾ç‰‡åŒº */
        .card-image-container { position:absolute; top:24px; left:4px; right:4px; bottom:calc(4px + 29.33mm);
            display:flex; align-items:center; justify-content:center; z-index:1; overflow:hidden; }
        .card-image-container img { max-width:100%; max-height:100%; object-fit:contain; display:block; }

        /* æ–‡æœ¬åŒº */
        .card-content { position:absolute; bottom:calc(4px + 16px); left:4px; right:4px;
            height:calc(50% - 4px - 16px); display:flex; flex-direction:column; justify-content:flex-end;
            gap:2px; overflow:hidden; z-index:2; font-size:10px; }

        /* æ–‡æœ¬æ¡† */
        .content-box{
            background: rgba(255,255,255,0.75);
            border: 3px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            padding: 3px;
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: start;
            overflow: hidden;
        }
        .content-box.attribute-box { border:none; }
        .box-title { font-weight:bold; font-size:10px; margin-right:3px; white-space:nowrap; }
        .box-content { font-size:9px; line-height:1.2; text-align:justify; overflow:hidden; }

        /* æŠ€èƒ½æ¡† */
        .skill-box { display:grid; grid-template-columns: auto 1fr; grid-auto-rows: auto; gap:4px; }
        .skill-name { font-weight:bold; font-size:10px; }
        .skill-desc { font-size:9px; }
        .skill-power { display:flex; flex-wrap:wrap; gap:2px; }
        .power-icon::before { content:'âœ¦'; font-size:10px; margin-right:1px; }

        /* åº•éƒ¨æ•°å€¼ */
        .monster .stats { position:absolute; bottom:4px; left:4px; right:4px; display:flex; justify-content:space-between;
            font-size:10px; background:rgba(255,255,255,0.9); padding:1px 4px; border-radius:4px; z-index:4; }
        .stats .atk::before { content:'â–²'; margin-right:2px; }
        .stats .def::before { content:'â—‡'; margin-right:2px; }

        /* çº¢è‰²æ ‡é¢˜ï¼šå“åº”æ•ˆæœ & ååº”å±æ€§ */

        .responsive-effect .box-title { color: red; }
        .reaction-attr .box-title { color: red; }
        .normal-attr .box-title { color: blue; }

        @page {               /* æ–°å¢ */
            margin: 0;        /* 0 mm é¡µè¾¹è· */
            size: auto;       /* è®©æµè§ˆå™¨ä¿æŒåŸçº¸å¼ å¤§å° */
        }

        @media print {
            body{background:none;margin:0;padding:0;}
            #main-content {
                width: calc(3 * 63mm + 2 * 2px) !important; /* 3 columns, 2 gaps */
                margin: 0 auto !important;
                box-sizing: border-box !important;
            }
            #card-container{
                display: grid !important;
                grid-template-columns: repeat(3, 63mm) !important;
                gap: 2px !important;
                box-sizing: border-box !important;
                overflow: visible !important;
            }
            .card{box-sizing: border-box !important; box-shadow:none;}
            .card.monster  { background:#ffffff !important; }
            .card.prophecy { background:#e9f1fb !important; }
        }

        /* English mode: smaller attribute text */
        body.en-mode .attribute-box .box-content {
            font-size: 8px !important;
        }
        /* English mode: smaller skill text if 3+ skills */
        body.en-mode .card.monster .content-box.skill-small .skill-desc {
            font-size: 8px !important;
        }

        #lang-switch span {
          user-select: none;
          border: 1px solid #3b82f6;
          margin: 0;
        }
        #lang-switch .active {
          background: #3b82f6 !important;
          color: #fff !important;
        }
        #lang-switch span:not(.active) {
          background: #23272f !important;
          color: #fff !important;
        }

        /* Sidebar styles */
        #sidebar-panel {
          border-top-right-radius: 0 !important;
          border-bottom-right-radius: 0 !important;
          border-radius: 0 !important;
          box-shadow: 2px 0 12px rgba(0,0,0,0.12);
          padding: 28px 18px 18px 18px;
          display: flex;
          flex-direction: column;
          gap: 18px;
          background: #23272f;
          color: #fff;
          z-index: 100;
          position: fixed;
          left: 0;
          top: 0;
          height: 100vh;
          width: 240px;
        }
        #sidebar-panel label[for="card-count"] {
          margin-bottom: 2px;
          font-size: 14px;
          font-weight: 500;
          display: block;
        }
        #sidebar-panel input[type="number"] {
          width: 100%;
          margin-bottom: 4px;
          border-radius: 4px;
          border: 1px solid #444;
          padding: 4px 8px;
          background: #181b20;
          color: #fff;
          outline: none;
          font-size: 15px;
          box-sizing: border-box;
        }
        #sidebar-panel .btn {
          width: 100%;
          border-radius: 4px;
          font-size: 15px;
          font-weight: 600;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
          margin-bottom: 0;
          margin-top: 0;
          box-sizing: border-box;
          padding: 8px 0;
        }
        #sidebar-panel .btn + .btn {
          margin-top: 8px;
        }
        #sidebar-panel .section {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-bottom: 8px;
        }
        #sidebar-panel .section + .section {
          margin-top: 8px;
        }
        #sidebar-panel .helper-text {
          font-size: 12px;
          color: #aaa;
          margin-bottom: 2px;
        }
        #sidebar-panel .divider {
          border-bottom: 1px solid #444;
          margin: 10px 0;
        }
        #sidebar-panel #lang-switch {
          margin-top: 4px;
        }
        #sidebar-panel .section-row {
          display: flex;
          flex-direction: row;
          align-items: center;
          gap: 8px;
          margin-bottom: 8px;
        }
    </style>
</head>
<body>
<div id="sidebar-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin:0 0 18px 0;">
    <h4 style="font-size:20px;letter-spacing:1px;font-weight:700;display:flex;align-items:center;gap:8px;margin:0;">
      <span style="font-size:22px;">ğŸƒ</span> æ§åˆ¶é¢æ¿
    </h4>
  </div>
  <div class="divider"></div>
  <div class="section">
    <div class="section-row">
      <label for="card-count" style="flex-shrink:0;">æ˜¾ç¤ºå¡ç‰Œæ•°é‡</label>
      <input id="card-count" type="number" min="1" value="9" style="flex:1;max-width:70px;min-width:40px;">
      <button id="btn-refresh" class="btn btn-primary mb-2" style="background:#23272f;border:none;border-radius:6px;padding:4px 8px;font-size:16px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:0;min-width:0;min-height:0;box-shadow:none;width:auto;height:32px;">
        <span>ğŸ”„</span>
      </button>
    </div>
    <span class="helper-text">å¯è°ƒæ•´æ˜¾ç¤ºçš„å¡ç‰Œå¯¹æ•°</span>
  </div>
  <div class="divider"></div>
  <div class="section">
    <button id="btn-print" class="btn btn-success"><span>ğŸ–¨ï¸</span> æ‰“å°/å¯¼å‡º PDF</button>
    <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;">
      <span style="font-size:14px;">è¯­è¨€</span>
      <div id="lang-switch" style="display:flex;align-items:center;gap:0;">
        <span id="lang-cn" style="font-size:14px;padding:2px 10px;border-radius:6px 0 0 6px;background:#3b82f6;color:#fff;cursor:pointer;transition:background 0.2s;">ä¸­æ–‡</span>
        <span id="lang-en" style="font-size:14px;padding:2px 10px;border-radius:0 6px 6px 0;background:#23272f;color:#fff;cursor:pointer;transition:background 0.2s;">English</span>
      </div>
    </div>
  </div>
  <div style="flex:1"></div>
  <div style="font-size:13px;color:#aaa;text-align:center;letter-spacing:1px;">Â© BoardGame å·¥å…·</div>
</div>
<div id="main-content" style="margin-left:240px;">
  <div id="card-container"></div>
</div>
<script>
    let lang = 'zh'; // 'zh' or 'en'

    /* ---------- å·¥å…· ---------- */
    // Robust pipe-splitting (copied from _editor.html)
    function parsePipeCsvLine(line) {
        const out = [];
        let cur = '';
        for (let i=0; i<line.length; i++) {
            const ch = line[i];
            if (ch === '\\') {
                const next = line[i+1];
                if (next === '|') { cur += '|'; i++; continue; }
                if (next === '\\') { cur += '\\'; i++; continue; }
                cur += '\\'; continue;
            }
            if (ch === '|') { out.push(cur); cur=''; continue; }
            cur += ch;
        }
        out.push(cur);
        return out;
    }
    async function loadCSV(path){
        const txt = await (await fetch(path)).text();
        return txt.split('\n').slice(1).filter(r=>r.trim());
    }
    // ä¿®æ­£ï¼šæ”¯æŒå•å¼•å· JSON
    function fixJsonQuotes(str) {
        if (!str) return str;
        if (str.trim().startsWith("'{") || str.trim().startsWith("'[") ) {
            str = str.trim().replace(/^'/, '').replace(/'$/, '');
        }
        return str.replace(/'/g, '"');
    }
    const safeParse = (str, def={}) => { try{ return JSON.parse(fixJsonQuotes(str)); } catch { return def; } };

    /* ---------- é¢„è¨€å¡ ---------- */
    function createProphecyCard(cols, langOverride) {
        const [title,intro,effect,responsive_effect='',image] =
        cols.length===4 ? [cols[0],cols[1],cols[2],'',cols[3]] : cols;
        const card = document.createElement('div'); card.className='card prophecy';
        if(image){
            card.style.setProperty('--prophecy-bg', `url('${image}')`);
        } else {
            card.style.removeProperty('--prophecy-bg');
        }
        card.innerHTML =
        `<div class="card-title"><span class="name">${title}</span></div>
         <div class="card-image-container"><img src="${image}"></div>`;
        const area = document.createElement('div'); area.className='card-content';
        // English/Chinese labels
        const l = (langOverride||lang);
        const labelEffect = l==='en' ? 'Effect' : 'æ•ˆæœ';
        const labelResponsive = l==='en' ? 'RespEkt' : 'å“åº”æ•ˆæœ';
        if(intro){
            area.innerHTML +=
            `<div class="content-box attribute-box">
               <div class="box-content">${intro}</div>
             </div>`;
        }
        if(effect){
            area.innerHTML +=
            `<div class="content-box">
               <div class="box-title">${labelEffect}</div>
               <div class="box-content">${effect}</div>
             </div>`;
        }
        if(responsive_effect){
            area.innerHTML +=
            `<div class="content-box responsive-effect">
               <div class="box-title">${labelResponsive}</div>
               <div class="box-content">${responsive_effect}</div>
             </div>`;
        }

        shrinkToFit(area);
        card.append(area);
        // Set the background image for the pseudo-element (in case of async rendering)
        setTimeout(()=>{
            card.style.setProperty('--prophecy-bg', image ? `url('${image}')` : 'none');
        }, 0);
        return card;
    }

    /* ---------- æ€ªå…½å¡ ---------- */
    // Patch createMonsterCard to add 'skill-small' class if 3+ skills and lang==='en'
    function createMonsterCard([title,level,type,desc,atk,def,magic,charStr,skillStr,image], langOverride) {
        const [title1,level1,type1,desc1,atk1,def1,magic1,charStr1,skillStr1,image1] = arguments[0];
        const attrs = safeParse(charStr1, {});
        let skills = safeParse(skillStr1, []);
        if (!Array.isArray(skills)) skills = [];
        skills = skills.map(sk => ({
            name: sk.name,
            energy_cost: sk.energy_cost,
            effect: sk.effect
        }));
        const lvlIcons = 'â–'.repeat(Math.max(0,parseInt(level1)));
        const l = (langOverride||lang);
        const labelNormal = l==='en' ? 'Attr' : 'é€šå¸¸å±æ€§';
        const labelReact = l==='en' ? 'RespAttr' : 'ååº”å±æ€§';
        const labelAtk = l==='en' ? 'ATK' : 'æ”»å‡»';
        const labelDef = l==='en' ? 'DEF' : 'é˜²å¾¡';
        const card = document.createElement('div'); card.className='card monster';
        card.innerHTML =
        `<div class="card-title">
             <span class="level">${lvlIcons}</span>
             <span class="name">${title1}</span>
             <span class="type">${type1}</span>
         </div>
         <div class="card-image-container"><img src="${image1}"></div>`;
        const area = document.createElement('div'); area.className='card-content';
        if(desc1){
            area.innerHTML +=
            `<div class="content-box attribute-box">
                 <div class="box-content">${desc1}</div>
             </div>`;
        }
        let normalChar = attrs.normal_attribute || '';
        let reactChar = attrs.responsive_attribute || '';
        if (normalChar) {
            area.innerHTML +=
                `<div class="content-box attribute-box normal-attr">
                     <div class="box-title">${labelNormal}</div>
                     <div class="box-content">${normalChar}</div>
                 </div>`;
        }
        if (reactChar) {
            area.innerHTML +=
                `<div class="content-box attribute-box reaction-attr">
                     <div class="box-title">${labelReact}</div>
                     <div class="box-content">${reactChar}</div>
                 </div>`;
        }
        // Add skill-small class if 3+ skills and lang is en
        let skillBoxClass = (l==='en' && skills.length>=3) ? 'content-box skill-small' : 'content-box';
        if(Array.isArray(skills)){
            skills.forEach(sk=>{
                area.innerHTML +=
                `<div class="${skillBoxClass}">
                     <div class="skill-box">
                         <div>
                             <div class="skill-name">${sk.name||''}</div>
                             <div class="skill-power">${'<span class="power-icon"></span>'.repeat(sk.energy_cost||0)}</div>
                         </div>
                         <div class="skill-desc">${sk.effect||''}</div>
                     </div>
                 </div>`;
            });
        }
        shrinkToFit(area);
        card.append(area);
        card.innerHTML +=
        `<div class="stats">
           <div class="atk">${labelAtk}: ${atk1}</div>
           <div class="def">${labelDef}: ${def1}</div>
         </div>`;
        return card;
    }

    /* ---------- ç¼©æ”¾ ---------- */
    function shrinkToFit(el){
        let fs=parseFloat(getComputedStyle(el).fontSize);
        while(el.scrollHeight>el.clientHeight && fs>5){
            fs-=0.5; el.style.fontSize=fs+'px';
        }
    }

    async function loadCSV(path) {
        const res = await fetch(path, { cache: 'no-store' });
        const text = await res.text();
        return text.split('\n').slice(1).filter(r => r.trim());
    }
    let allProphecyRows = [], allMonsterRows = [];
    let displayCount = 9;

    async function renderAllCards() {
        const ctr = document.getElementById('card-container');
        ctr.innerHTML = '';

        // Only use the latest N cards (interleaved)
        const prophecyRows = allProphecyRows.slice(-displayCount);
        const monsterRows = allMonsterRows.slice(-displayCount);
        const maxLen = Math.max(prophecyRows.length, monsterRows.length);
        for (let i = 0; i < maxLen; i++) {
            if (i < prophecyRows.length) {
                ctr.append(createProphecyCard(parsePipeCsvLine(prophecyRows[i])));
            }
            if (i < monsterRows.length) {
                ctr.append(createMonsterCard(parsePipeCsvLine(monsterRows[i])));
            }
        }
    }

    async function reloadCSVsAndRender() {
        // é€‚é… GitHub Pagesï¼šè‡ªåŠ¨ä»å½“å‰ HTML æ‰€åœ¨ç›®å½•åŠ è½½ CSV
        function getCsvUrl(filename) {
            // å–å½“å‰ HTML è·¯å¾„ï¼Œæ‹¼æ¥ CSV æ–‡ä»¶å
            const base = window.location.pathname.replace(/\/[^/]*$/, '/');
            return base + filename;
        }
        if(lang==='en'){
            allProphecyRows = await loadCSV('prophecy_cards_en.csv');
            allMonsterRows = await loadCSV('monster_cards_en.csv');
        }else{
            allProphecyRows = await loadCSV('prophecy_cards.csv');
            allMonsterRows = await loadCSV('monster_cards.csv');
        }
        renderAllCards();
    }

    function setLangClass() {
        document.body.classList.toggle('en-mode', lang==='en');
    }

    /* ---------- ä¸»å…¥å£ ---------- */
    document.addEventListener('DOMContentLoaded', () => {
        // Initial load
        reloadCSVsAndRender();
        setLangClass();

        // Refresh button
        document.getElementById('btn-refresh').onclick = reloadCSVsAndRender;

        // Card count input
        const cardCountInput = document.getElementById('card-count');
        cardCountInput.onchange = function() {
            let val = parseInt(cardCountInput.value, 10);
            if (isNaN(val) || val < 1) val = 1;
            displayCount = val;
            renderAllCards();
        };

        // Print button
        document.getElementById('btn-print').onclick = function() {
            // Hide sidebar for print
            document.getElementById('sidebar-panel').style.display = 'none';
            document.getElementById('main-content').style.marginLeft = '0';
            setTimeout(()=>{
                window.print();
                // Restore sidebar after print
                setTimeout(()=>{
                    document.getElementById('sidebar-panel').style.display = '';
                    document.getElementById('main-content').style.marginLeft = '240px';
                }, 100);
            }, 50);
        };

        // Language switch logic
        function updateLangSwitch() {
            document.getElementById('lang-cn').classList.toggle('active', lang === 'zh');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
        }
        updateLangSwitch();
        document.getElementById('lang-cn').onclick = function() {
            if(lang !== 'zh') {
                lang = 'zh';
                reloadCSVsAndRender();
                setLangClass();
                updateLangSwitch();
            }
        };
        document.getElementById('lang-en').onclick = function() {
            if(lang !== 'en') {
                lang = 'en';
                reloadCSVsAndRender();
                setLangClass();
                updateLangSwitch();
            }
        };
    });

</script>
</body>
</html>
