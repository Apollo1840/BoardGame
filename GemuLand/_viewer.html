<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <title>卡牌生成器</title>
    <style>
        /* 打印保真 */
        img, .content-box, .card-title { print-color-adjust: exact; }
        body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
        #card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(63mm,1fr)); gap:10px; justify-items:center; }

        /* 卡牌基座 */
        .card {
            position: relative;
            width: 63mm;
            height: 88mm;
            border: 1.5px solid #000;
            border-radius: 8px;
            overflow: hidden;
            page-break-inside: avoid;
            -webkit-print-color-adjust: exact;   /* 旧版 Chromium、Safari */
            print-color-adjust: exact;           /* 新标准写法 */
        }

        /* 分类底色 */
        .card.monster  { background:#ffffff; }   /* 纯白色 */
        .card.prophecy {
            position: relative;
            background: none;
        }
        .card.prophecy::before {
            content: '';
            position: absolute;
            inset: 0;
            z-index: 0;
            background-image: var(--prophecy-bg, none);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            filter: blur(12px) brightness(0.7) saturate(1.2);
            border-radius: 8px;
            transition: background-image 0.3s;
        }
        .card.prophecy .card-image-container {
            position: absolute;
            top: 24px;
            left: 4px;
            right: 4px;
            bottom: calc(4px + 29.33mm);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            overflow: hidden;
        }
        .card.prophecy .card-content {
            position: absolute;
            bottom: calc(4px + 16px);
            left: 4px;
            right: 4px;
            height: calc(50% - 4px - 16px);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            gap: 2px;
            overflow: hidden;
            z-index: 3;
            font-size: 10px;
        }
        .card.prophecy .card-title {
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(10,30,80,0.5) !important;
            border-radius: 4px;
            padding: 2px 4px;
            font-weight: bold;
            font-size: 12px;
            z-index: 3;
            color: #fff !important;
        }

        /* 预言卡文本框深蓝半透明底白字 */
        .card.prophecy .content-box {
            background: rgba(10,30,80,0.5) !important;
            color: #fff !important;
            border-color: rgba(255,255,255,0.2) !important;
        }
        .card.prophecy .box-title,
        .card.prophecy .box-content {
            color: #fff !important;
        }
        /* 响应效果标题依然为红色 */
        .card.prophecy .responsive-effect .box-title {
            color: red !important;
        }
        .card.prophecy .card-title {
            background: rgba(10,30,80,0.5) !important;
            color: #fff !important;
        }

        /* 标题栏 */
        .card-title { position:absolute; top:4px; left:4px; right:4px; display:flex; justify-content:space-between; align-items:center;
            background:rgba(255,255,255,0.9); border-radius:4px; padding:2px 4px; font-weight:bold; font-size:12px; z-index:3; }
        .card-title .level, .card-title .type { font-size:11px; width:15%; text-align:center; }
        .card-title .name { font-size:12px; flex:1; text-align:center; }
        .prophecy .card-title { justify-content:center; }

        /* 图片区 */
        .card-image-container { position:absolute; top:24px; left:4px; right:4px; bottom:calc(4px + 29.33mm);
            display:flex; align-items:center; justify-content:center; z-index:1; overflow:hidden; }
        .card-image-container img { max-width:100%; max-height:100%; object-fit:contain; display:block; }

        /* 文本区 */
        .card-content { position:absolute; bottom:calc(4px + 16px); left:4px; right:4px;
            height:calc(50% - 4px - 16px); display:flex; flex-direction:column; justify-content:flex-end;
            gap:2px; overflow:hidden; z-index:2; font-size:10px; }

        /* 文本框 */
        .content-box{
            background: rgba(255,255,255,0.75);
            border: 3px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            padding: 3px;
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: start;
            overflow: hidden;
        }
        .content-box.attribute-box { border:none; }
        .box-title { font-weight:bold; font-size:10px; margin-right:3px; white-space:nowrap; }
        .box-content { font-size:9px; line-height:1.2; text-align:justify; overflow:hidden; }

        /* 技能框 */
        .skill-box { display:grid; grid-template-columns: auto 1fr; grid-auto-rows: auto; gap:4px; }
        .skill-name { font-weight:bold; font-size:10px; }
        .skill-desc { font-size:9px; }
        .skill-power { display:flex; flex-wrap:wrap; gap:2px; }
        .power-icon::before { content:'✦'; font-size:10px; margin-right:1px; }

        /* 底部数值 */
        .monster .stats { position:absolute; bottom:4px; left:4px; right:4px; display:flex; justify-content:space-between;
            font-size:10px; background:rgba(255,255,255,0.9); padding:1px 4px; border-radius:4px; z-index:4; }
        .stats .atk::before { content:'▲'; margin-right:2px; }
        .stats .def::before { content:'◇'; margin-right:2px; }

        /* 红色标题：响应效果 & 反应属性 */

        .responsive-effect .box-title { color: red; }
        .reaction-attr .box-title { color: red; }
        .normal-attr .box-title { color: blue; }

        @page {               /* 新增 */
            margin: 0;        /* 0 mm 页边距 */
            size: auto;       /* 让浏览器保持原纸张大小 */
        }

        @media print {
            body{background:none;margin:0;padding:0;}   /* 原来已有 padding:0，这里同时把 margin 也归零 */
            #card-container{gap:5px;}
            .card{box-shadow:none;}
            .card.monster  { background:#ffffff !important; }
            .card.prophecy { background:#e9f1fb !important; }
        }

        /* English mode: smaller attribute text */
        body.en-mode .attribute-box .box-content {
            font-size: 8px !important;
        }
        /* English mode: smaller skill text if 3+ skills */
        body.en-mode .card.monster .content-box.skill-small .skill-desc {
            font-size: 8px !important;
        }

    </style>
</head>
<body>
<div id="sidebar-panel" style="position:fixed;left:0;top:0;height:100vh;width:220px;background:#222;color:#fff;z-index:100;box-shadow:2px 0 8px rgba(0,0,0,0.08);padding:24px 16px 16px 16px;display:flex;flex-direction:column;gap:18px;">
  <h4 style="margin:0 0 12px 0;font-size:18px;">控制面板</h4>
  <button id="btn-refresh" class="btn btn-primary mb-2" style="width:100%;">刷新卡牌</button>
  <div class="mb-2">
    <label for="card-count" style="font-size:14px;">显示卡牌数量</label>
    <input id="card-count" type="number" min="1" value="9" style="width:100%;margin-top:4px;">
  </div>
  <button id="btn-print" class="btn btn-success" style="width:100%;">打印/导出 PDF</button>
  <button id="btn-lang" class="btn btn-secondary mb-2" style="width:100%;">English Mode</button>
  <div style="flex:1"></div>
  <div style="font-size:12px;color:#aaa;text-align:center;">© BoardGame 工具</div>
</div>
<div id="main-content" style="margin-left:240px;">
  <div id="card-container"></div>
</div>
<script>
    let lang = 'zh'; // 'zh' or 'en'

    /* ---------- 工具 ---------- */
    // Robust pipe-splitting (copied from _editor.html)
    function parsePipeCsvLine(line) {
        const out = [];
        let cur = '';
        for (let i=0; i<line.length; i++) {
            const ch = line[i];
            if (ch === '\\') {
                const next = line[i+1];
                if (next === '|') { cur += '|'; i++; continue; }
                if (next === '\\') { cur += '\\'; i++; continue; }
                cur += '\\'; continue;
            }
            if (ch === '|') { out.push(cur); cur=''; continue; }
            cur += ch;
        }
        out.push(cur);
        return out;
    }
    async function loadCSV(path){
        const txt = await (await fetch(path)).text();
        return txt.split('\n').slice(1).filter(r=>r.trim());
    }
    // 修正：支持单引号 JSON
    function fixJsonQuotes(str) {
        if (!str) return str;
        if (str.trim().startsWith("'{") || str.trim().startsWith("'[") ) {
            str = str.trim().replace(/^'/, '').replace(/'$/, '');
        }
        return str.replace(/'/g, '"');
    }
    const safeParse = (str, def={}) => { try{ return JSON.parse(fixJsonQuotes(str)); } catch { return def; } };

    /* ---------- 预言卡 ---------- */
    function createProphecyCard(cols, langOverride) {
        const [title,intro,effect,responsive_effect='',image] =
        cols.length===4 ? [cols[0],cols[1],cols[2],'',cols[3]] : cols;
        const card = document.createElement('div'); card.className='card prophecy';
        if(image){
            card.style.setProperty('--prophecy-bg', `url('${image}')`);
        } else {
            card.style.removeProperty('--prophecy-bg');
        }
        card.innerHTML =
        `<div class="card-title"><span class="name">${title}</span></div>
         <div class="card-image-container"><img src="${image}"></div>`;
        const area = document.createElement('div'); area.className='card-content';
        // English/Chinese labels
        const l = (langOverride||lang);
        const labelEffect = l==='en' ? 'Effect' : '效果';
        const labelResponsive = l==='en' ? 'ResEkt' : '响应效果';
        if(intro){
            area.innerHTML +=
            `<div class="content-box attribute-box">
               <div class="box-content">${intro}</div>
             </div>`;
        }
        if(effect){
            area.innerHTML +=
            `<div class="content-box">
               <div class="box-title">${labelEffect}</div>
               <div class="box-content">${effect}</div>
             </div>`;
        }
        if(responsive_effect){
            area.innerHTML +=
            `<div class="content-box responsive-effect">
               <div class="box-title">${labelResponsive}</div>
               <div class="box-content">${responsive_effect}</div>
             </div>`;
        }

        shrinkToFit(area);
        card.append(area);
        // Set the background image for the pseudo-element (in case of async rendering)
        setTimeout(()=>{
            card.style.setProperty('--prophecy-bg', image ? `url('${image}')` : 'none');
        }, 0);
        return card;
    }

    /* ---------- 怪兽卡 ---------- */
    // Patch createMonsterCard to add 'skill-small' class if 3+ skills and lang==='en'
    function createMonsterCard([title,level,type,desc,atk,def,magic,charStr,skillStr,image], langOverride) {
        const [title1,level1,type1,desc1,atk1,def1,magic1,charStr1,skillStr1,image1] = arguments[0];
        const attrs = safeParse(charStr1, {});
        let skills = safeParse(skillStr1, []);
        if (!Array.isArray(skills)) skills = [];
        skills = skills.map(sk => ({
            name: sk.name,
            energy_cost: sk.energy_cost,
            effect: sk.effect
        }));
        const lvlIcons = '❖'.repeat(Math.max(0,parseInt(level1)));
        const l = (langOverride||lang);
        const labelNormal = l==='en' ? 'NorAttr' : '通常属性';
        const labelReact = l==='en' ? 'RespAttr' : '反应属性';
        const labelAtk = l==='en' ? 'ATK' : '攻击';
        const labelDef = l==='en' ? 'DEF' : '防御';
        const card = document.createElement('div'); card.className='card monster';
        card.innerHTML =
        `<div class="card-title">
             <span class="level">${lvlIcons}</span>
             <span class="name">${title1}</span>
             <span class="type">${type1}</span>
         </div>
         <div class="card-image-container"><img src="${image1}"></div>`;
        const area = document.createElement('div'); area.className='card-content';
        if(desc1){
            area.innerHTML +=
            `<div class="content-box attribute-box">
                 <div class="box-content">${desc1}</div>
             </div>`;
        }
        let normalChar = attrs.normal_attribute || '';
        let reactChar = attrs.responsive_attribute || '';
        if (normalChar) {
            area.innerHTML +=
                `<div class="content-box attribute-box normal-attr">
                     <div class="box-title">${labelNormal}</div>
                     <div class="box-content">${normalChar}</div>
                 </div>`;
        }
        if (reactChar) {
            area.innerHTML +=
                `<div class="content-box attribute-box reaction-attr">
                     <div class="box-title">${labelReact}</div>
                     <div class="box-content">${reactChar}</div>
                 </div>`;
        }
        // Add skill-small class if 3+ skills and lang is en
        let skillBoxClass = (l==='en' && skills.length>=3) ? 'content-box skill-small' : 'content-box';
        if(Array.isArray(skills)){
            skills.forEach(sk=>{
                area.innerHTML +=
                `<div class="${skillBoxClass}">
                     <div class="skill-box">
                         <div>
                             <div class="skill-name">${sk.name||''}</div>
                             <div class="skill-power">${'<span class="power-icon"></span>'.repeat(sk.energy_cost||0)}</div>
                         </div>
                         <div class="skill-desc">${sk.effect||''}</div>
                     </div>
                 </div>`;
            });
        }
        shrinkToFit(area);
        card.append(area);
        card.innerHTML +=
        `<div class="stats">
           <div class="atk">${labelAtk}: ${atk1}</div>
           <div class="def">${labelDef}: ${def1}</div>
         </div>`;
        return card;
    }

    /* ---------- 缩放 ---------- */
    function shrinkToFit(el){
        let fs=parseFloat(getComputedStyle(el).fontSize);
        while(el.scrollHeight>el.clientHeight && fs>5){
            fs-=0.5; el.style.fontSize=fs+'px';
        }
    }

    async function loadCSV(path) {
        const res = await fetch(path, { cache: 'no-store' });
        const text = await res.text();
        return text.split('\n').slice(1).filter(r => r.trim());
    }
    let allProphecyRows = [], allMonsterRows = [];
    let displayCount = 9;

    async function renderAllCards() {
        const ctr = document.getElementById('card-container');
        ctr.innerHTML = '';

        // Only use the latest N cards (interleaved)
        const prophecyRows = allProphecyRows.slice(-displayCount);
        const monsterRows = allMonsterRows.slice(-displayCount);
        const maxLen = Math.max(prophecyRows.length, monsterRows.length);
        for (let i = 0; i < maxLen; i++) {
            if (i < prophecyRows.length) {
                ctr.append(createProphecyCard(parsePipeCsvLine(prophecyRows[i])));
            }
            if (i < monsterRows.length) {
                ctr.append(createMonsterCard(parsePipeCsvLine(monsterRows[i])));
            }
        }
    }

    async function reloadCSVsAndRender() {
        if(lang==='en'){
            allProphecyRows = await loadCSV('prophecy_cards_en.csv');
            allMonsterRows = await loadCSV('monster_cards_en.csv');
        }else{
            allProphecyRows = await loadCSV('prophecy_cards.csv');
            allMonsterRows = await loadCSV('monster_cards.csv');
        }
        renderAllCards();
    }

    function setLangClass() {
        document.body.classList.toggle('en-mode', lang==='en');
    }

    /* ---------- 主入口 ---------- */
    document.addEventListener('DOMContentLoaded', () => {
        // Initial load
        reloadCSVsAndRender();
        setLangClass();

        // Refresh button
        document.getElementById('btn-refresh').onclick = reloadCSVsAndRender;

        // Card count input
        const cardCountInput = document.getElementById('card-count');
        cardCountInput.onchange = function() {
            let val = parseInt(cardCountInput.value, 10);
            if (isNaN(val) || val < 1) val = 1;
            displayCount = val;
            renderAllCards();
        };

        // Print button
        document.getElementById('btn-print').onclick = function() {
            // Hide sidebar for print
            document.getElementById('sidebar-panel').style.display = 'none';
            document.getElementById('main-content').style.marginLeft = '0';
            setTimeout(()=>{
                window.print();
                // Restore sidebar after print
                setTimeout(()=>{
                    document.getElementById('sidebar-panel').style.display = '';
                    document.getElementById('main-content').style.marginLeft = '240px';
                }, 100);
            }, 50);
        };

        // Language switch button
        const btnLang = document.getElementById('btn-lang');
        btnLang.onclick = function() {
            lang = (lang==='zh') ? 'en' : 'zh';
            btnLang.textContent = lang==='en' ? '中文模式' : 'English Mode';
            reloadCSVsAndRender();
            setLangClass();
        };
    });

</script>
</body>
</html>
