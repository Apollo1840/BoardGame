<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <title>卡牌生成器（20mm 背景网格，卡牌下方隐形）</title>
  <style>
    /* ---------- 参数（统一用 mm） ---------- */
    :root{
      --card-w: 63mm;
      --card-h: 88mm;
      --border: 0.53mm;   /* ≈2px */
      --gap: 0.53mm;      /* ≈2px */
      --tick: 0.20mm;     /* 线宽（保留以备后用） */
      --cols: 3;

      /* 背景网格参数（每 20mm 一条线） */
      --grid-step: 20mm;
      --grid-tick: 0.18mm;
      --grid-color: rgba(120,120,120,.9);
    }

    /* 屏幕态基础样式 */
    img, .content-box, .card-title { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    html, body { height: 100%; }
    body {
      font-family: sans-serif;
      padding: 20px;
      margin: 0;

      /* === 20mm 背景网格（整页，位于所有内容之下） === */
      background:
        /* 竖线 */
        repeating-linear-gradient(
          to right,
          transparent 0,
          transparent calc(var(--grid-step) - var(--grid-tick)),
          var(--grid-color) calc(var(--grid-step) - var(--grid-tick)),
          var(--grid-color) var(--grid-step)
        ),
        /* 横线 */
        repeating-linear-gradient(
          to bottom,
          transparent 0,
          transparent calc(var(--grid-step) - var(--grid-tick)),
          var(--grid-color) calc(var(--grid-step) - var(--grid-tick)),
          var(--grid-color) var(--grid-step)
        ),
        /* 背景底色 */
        #ffffff;
      background-repeat: repeat, repeat, no-repeat;
      background-position: 0 0, 0 0, 0 0;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    #card-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(63mm,1fr));
      gap: var(--gap); /* Use the same gap for both rows and columns */
      justify-items:left; align-items:start;
    }

    .card {
      position: relative;
      width: var(--card-w);
      height: 88mm;
      border: 2px solid #000; border-radius: 8px;
      overflow: hidden; page-break-inside: avoid;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
      /* ★ 关键：不透明白底，完全遮挡页面背景网格（卡牌区域内“隐形”） */
      background-color: #ffffff;
      isolation: isolate;
    }

    .card.prophecy::before{
      content:''; position:absolute; inset:0; z-index:0;
      background-image: var(--prophecy-bg, none);
      background-size: cover; background-position: center; background-repeat: no-repeat;
      filter: blur(12px) brightness(0.7) saturate(1.2);
      border-radius: 8px; transition: background-image .3s;
    }
    .card.prophecy .card-image-container{ position:absolute; top:24px; left:4px; right:4px; bottom:calc(4px + 29.33mm);
      display:flex; align-items:center; justify-content:center; z-index:2; overflow:hidden; }
    .card.prophecy .card-content{ position:absolute; bottom:calc(4px + 16px); left:4px; right:4px; height:calc(50% - 4px - 16px);
      display:flex; flex-direction:column; justify-content:flex-end; gap:2px; overflow:hidden; z-index:3; font-size:10px; }
    .card.prophecy .card-title{
      position:absolute; top:4px; left:4px; right:4px; display:flex; justify-content:center; align-items:center;
      background:rgba(10,30,80,0.5)!important; border-radius:4px; padding:2px 4px; font-weight:bold; font-size:12px; z-index:3; color:#fff!important;
    }
    .card.prophecy .content-box{ background:rgba(10,30,80,0.5)!important; color:#fff!important; border-color:rgba(255,255,255,0.2)!important; }
    .card.prophecy .box-title,.card.prophecy .box-content{ color:#fff!important; }
    .card.prophecy .responsive-effect .box-title{ color:red!important; }

    .card-title{
      position:absolute; top:4px; left:4px; right:4px; display:flex; justify-content:space-between; align-items:center;
      background:rgba(255,255,255,0.9); border-radius:4px; padding:2px 4px; font-weight:bold; font-size:12px; z-index:3;
    }
    .card-title .level,.card-title .type{ font-size:11px; width:15%; text-align:center; }
    .card-title .name{ font-size:12px; flex:1; text-align:center; }
    .prophecy .card-title{ justify-content:center; }

    .card-image-container{ position:absolute; top:24px; left:4px; right:4px; bottom:calc(4px + 29.33mm);
      display:flex; align-items:center; justify-content:center; z-index:1; overflow:hidden; }
    .card-image-container img{ max-width:100%; max-height:100%; object-fit:contain; display:block; }

    .card-content{ position:absolute; bottom:calc(4px + 16px); left:4px; right:4px; height:calc(50% - 4px - 16px);
      display:flex; flex-direction:column; justify-content:flex-end; gap:2px; overflow:hidden; z-index:2; font-size:10px; }

    .content-box{ background:rgba(255,255,255,0.75); border:3px solid rgba(0,0,0,0.2); border-radius:4px; padding:3px;
      display:grid; grid-template-columns:auto 1fr; align-items:start; overflow:hidden; }
    .content-box.attribute-box{ border:none; }
    .box-title{ font-weight:bold; font-size:10px; margin-right:3px; white-space:nowrap; }
    .box-content{ font-size:9px; line-height:1.2; text-align:justify; overflow:hidden; }

    .skill-box{ display:grid; grid-template-columns:auto 1fr; grid-auto-rows:auto; gap:4px; }
    .skill-name{ font-weight:bold; font-size:10px; }
    .skill-desc{ font-size:9px; }
    .skill-power{ display:flex; flex-wrap:wrap; gap:2px; }
    .power-icon::before{ content:'✦'; font-size:10px; margin-right:1px; }

    .card.monster .stats{ position:absolute; bottom:4px; left:4px; right:4px; display:flex; justify-content:space-between;
      font-size:10px; background:rgba(255,255,255,0.9); padding:1px 4px; border-radius:4px; z-index:4; }
    .stats .atk::before{ content:'▲'; margin-right:2px; }
    .stats .def::before{ content:'◇'; margin-right:2px; }

    .responsive-effect .box-title{ color:red; }
    .reaction-attr .box-title{ color:red; }
    .normal-attr .box-title{ color:blue; }

    /* 侧边栏（含语言切换） */
    #lang-switch span{ user-select:none; border:1px solid #3b82f6; margin:0; cursor:pointer; }
    #lang-switch .active{ background:#3b82f6!important; color:#fff!important; }
    #lang-switch span:not(.active){ background:#23272f!important; color:#fff!important; }

    #sidebar-panel{
      border-radius:0!important; box-shadow:2px 0 12px rgba(0,0,0,0.12);
      padding:28px 18px 18px; display:flex; flex-direction:column; gap:18px;
      background:#23272f; color:#fff; z-index:100; position:fixed; left:0; top:0; height:100vh; width:240px;
    }
    #sidebar-panel input[type="number"]{ width:100%; margin-bottom:4px; border-radius:4px; border:1px solid #444; padding:4px 8px; background:#181b20; color:#fff; outline:none; font-size:15px; box-sizing:border-box; }
    #sidebar-panel select{ width:100%; border-radius:4px; border:1px solid #444; padding:4px 8px; background:#181b20; color:#fff; font-size:15px; }
    #sidebar-panel .btn{ width:100%; border-radius:6px; font-size:15px; font-weight:600; display:flex; align-items:center; justify-content:center; gap:6px; margin:0; box-sizing:border-box; padding:8px 0; background:#3b82f6; color:#fff; border:none; }
    #sidebar-panel .section{ display:flex; flex-direction:column; gap:8px; margin-bottom:8px; }
    #sidebar-panel .divider{ border-bottom:1px solid #444; margin:10px 0; }
    #sidebar-panel .section-row{ display:flex; align-items:center; gap:8px; margin-bottom:8px; }

    /* 主内容区 */
    #main-content{ margin-left:240px; position:relative; }

    /* 打印时固定列宽网格（与 20mm 背景无耦合） */
    .fixed-print-width {
      width: calc(var(--cols) * var(--card-w) + (var(--cols) - 1) * var(--gap)) !important;
      margin: 0 auto !important;
      background: none !important;
      box-sizing: border-box !important;
    }
    .grid-for-print {
      display: grid !important;
      grid-template-columns: repeat(var(--cols), var(--card-w)) !important;
      gap: var(--gap) !important;
      box-sizing: border-box !important;
      overflow: visible !important;
      margin: 0 auto !important;
    }
    .card-print-size{
      box-sizing: border-box!important;
      width: var(--card-w)!important;
      height: var(--card-h)!important;
      border: var(--border) solid #000!important; 
      box-shadow:none!important;
      margin: 0!important;
      justify-self: start;
    }

    /* 打印介质设置 */
    @page { margin: 0; size: auto; }
    @media print{
      html, body { margin:0!important; padding:0!important; }
      #sidebar-panel{ display:none!important; }
      #main-content{ margin-left:0!important; }
      body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }

    /* English mode */
    body.en-mode .attribute-box .box-content{ font-size:8px!important; }
    body.en-mode .card.monster .content-box.skill-small .skill-desc{ font-size:8px!important; }
  </style>
</head>
<body>
  <div id="sidebar-panel">
    <div style="display:flex;align-items:center;justify-content:space-between;margin:0 0 18px 0;">
      <h4 style="font-size:20px;letter-spacing:1px;font-weight:700;display:flex;align-items:center;gap:8px;margin:0;">
        <span style="font-size:22px;">🃏</span> 控制面板
      </h4>
    </div>

    <div class="divider"></div>

    <div class="section">
      <div class="section-row">
        <label for="card-count" style="flex-shrink:0;">显示卡牌数量</label>
        <input id="card-count" type="number" min="1" value="9" style="flex:1;max-width:80px;min-width:60px;">
        <button id="btn-refresh" class="btn" title="重新加载/排序"><span>🔄</span> 刷新</button>
      </div>
      <span class="helper-text" style="color:#bbb;font-size:12px;">可调整显示的卡牌对数</span>
    </div>

    <div class="section">
      <div class="section-row">
        <label for="sort-field" style="flex-shrink:0;">排序方式</label>
        <select id="sort-field" style="flex:1;">
          <option value="description">描述</option>
          <option value="update_datetime" selected>更新时间</option>
          <option value="card_id">卡牌ID</option>
        </select>
      </div>
      <div class="section-row" style="margin-top:8px;">
        <label style="flex-shrink:0;">交替显示</label>
        <input id="alt-display-toggle" type="checkbox" style="margin-left:8px;" checked>
        <span class="helper-text" style="margin-left:8px;color:#bbb;font-size:12px;">怪物与预言交替</span>
      </div>
    </div>

    <div class="divider"></div>

    <div class="section">
      <button id="btn-print" class="btn"><span>🖨️</span> 打印/导出 PDF</button>
      <div style="font-size:12px;color:#aaa;line-height:1.3;margin-top:6px;">
        打印时请勾选“打印背景图形 / Background graphics”
      </div>
    </div>

    <div class="section">
      <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;">
        <span style="font-size:14px;">语言</span>
        <div id="lang-switch" style="display:flex;align-items:center;gap:0;">
          <span id="lang-cn" class="active" style="font-size:14px;padding:2px 10px;border-radius:6px 0 0 6px;">中文</span>
          <span id="lang-en" style="font-size:14px;padding:2px 10px;border-radius:0 6px 6px 0;">English</span>
        </div>
      </div>
    </div>

    <div style="flex:1"></div>
    <div style="font-size:13px;color:#aaa;text-align:center;letter-spacing:1px;">© BoardGame 工具</div>
  </div>

  <div id="main-content" style="position:relative; margin-left:240px;">
    <div id="card-container"></div>
  </div>

  <script>
    // Decode \n to real newlines
    function decodeText(s){ return String(s??'').replace(/\\\|/g,'|').replace(/\\n/g,'\n'); }
    let lang = 'zh';

    /* ---------- CSV/解析 ---------- */
    function parsePipeCsvLine(line){
      const out=[]; let cur='';
      for (let i=0;i<line.length;i++){
        const ch=line[i];
        if (ch==='\\'){
          const next=line[i+1];
          if (next==='|'){ cur+='|'; i++; continue; }
          if (next==='\\'){ cur+='\\'; i++; continue; }
          cur+='\\'; continue;
        }
        if (ch==='|'){ out.push(cur); cur=''; continue; }
        cur+=ch;
      }
      out.push(cur); return out;
    }
    const parseCsvHeader=(line)=>parsePipeCsvLine(line);
    function mapCsvRowToObj(headerArr,rowArr){
      const obj={}; for(let i=0;i<headerArr.length;i++){ obj[headerArr[i]]=rowArr[i]!==undefined?decodeText(rowArr[i]):''; }
      return obj;
    }
    async function loadCSVWithHeader(path){
      const txt=await (await fetch(path)).text();
      const lines=txt.split('\n').filter(r=>r.trim());
      if (!lines.length) return {headerArr: [], rowsArr: []};
      return {headerArr:parseCsvHeader(lines[0]), rowsArr:lines.slice(1).map(parsePipeCsvLine)};
    }
    function fixJsonQuotes(str){
      if (!str) return str;
      if (str.trim().startsWith("'{")||str.trim().startsWith("'[")) str=str.trim().replace(/^'/,'').replace(/'$/,'');
      return str.replace(/'/g,'"');
    }
    const safeParse=(s,def={})=>{ try{return JSON.parse(fixJsonQuotes(s));}catch{return def;} };

    /* ---------- 卡片渲染 ---------- */
    function createProphecyCard(row,langOverride){
      let obj=Array.isArray(row)?(()=>{const [t,i,e,r='',img]=row.length===4?[row[0],row[1],row[2],'',row[3]]:row; return {card_title:t,introduction:i,effect:e,responsive_effect:r,image:img};})():row;
      const card=document.createElement('div'); card.className='card prophecy';
      if(obj.image){ card.style.setProperty('--prophecy-bg',`url('${obj.image}')`);} else { card.style.removeProperty('--prophecy-bg');}
      card.innerHTML=`<div class="card-title"><span class="name">${obj.card_title||''}</span></div>
                      <div class="card-image-container"><img src="${obj.image||''}" alt=""></div>`;
      const area=document.createElement('div'); area.className='card-content';
      const l=(langOverride||lang);
      const labelEffect=l==='en'?'Effect':'效果';
      const labelResponsive=l==='en'?'Responsive Effect':'响应效果';
      const nl2br=s=>String(s).replace(/\n/g,'<br>');
      if(obj.introduction){ area.innerHTML+=`<div class="content-box attribute-box"><div class="box-content">${nl2br(obj.introduction)}</div></div>`; }
      if(obj.effect){ area.innerHTML+=`<div class="content-box"><div class="box-title">${labelEffect}</div><div class="box-content">${nl2br(obj.effect)}</div></div>`; }
      if(obj.responsive_effect){ area.innerHTML+=`<div class="content-box responsive-effect"><div class="box-title">${labelResponsive}</div><div class="box-content">${nl2br(obj.responsive_effect)}</div></div>`; }
      shrinkToFit(area); card.append(area);
      setTimeout(()=>{ card.style.setProperty('--prophecy-bg', obj.image?`url('${obj.image}')`:'none'); },0);
      return card;
    }

    function createMonsterCard(row,langOverride){
      let obj=Array.isArray(row)?(()=>{const [t,l,ty,desc,atk,def,magic,charStr,skillStr,img]=row; return {card_title:t, level:l, monster_type:ty, description:desc, attack:atk, defence:def, magic, attributes:charStr, skills:skillStr, image:img};})():row;
      const attrs=safeParse(obj.attributes,{});
      let skills=safeParse(obj.skills,[]); if(!Array.isArray(skills)) skills=[];
      skills=skills.map(sk=>({name:sk.name, energy_cost:sk.energy_cost, effect:sk.effect}));
      const lvlIcons='❖'.repeat(Math.max(0,parseInt(obj.level)));
      const l=(langOverride||lang);
      const labelNormal=l==='en'?'Attr':'通常属性';
      const labelReact=l==='en'?'RespAttr':'反应属性';
      const labelAtk=l==='en'?'ATK':'攻击';
      const labelDef=l==='en'?'DEF':'防御';
      const card=document.createElement('div'); card.className='card monster';
      card.innerHTML=`<div class="card-title"><span class="level">${lvlIcons}</span><span class="name">${obj.card_title||''}</span><span class="type">${obj.monster_type||''}</span></div>
                      <div class="card-image-container"><img src="${obj.image||''}" alt=""></div>`;
      const area=document.createElement('div'); area.className='card-content';
      const nl2br=s=>String(s).replace(/\n/g,'<br>');
      if(obj.description){ area.innerHTML+=`<div class="content-box attribute-box"><div class="box-content">${nl2br(obj.description)}</div></div>`; }
      let normalChar=attrs.normal_attribute||'';
      let reactChar=attrs.responsive_attribute||'';
      if(normalChar){ area.innerHTML+=`<div class="content-box attribute-box normal-attr"><div class="box-title">${labelNormal}</div><div class="box-content">${nl2br(normalChar)}</div></div>`; }
      if(reactChar){ area.innerHTML+=`<div class="content-box attribute-box reaction-attr"><div class="box-title">${labelReact}</div><div class="box-content">${nl2br(reactChar)}</div></div>`; }
      let skillBoxClass=(l==='en'&&skills.length>=3)?'content-box skill-small':'content-box';
      skills.forEach(sk=>{
        area.innerHTML+=`<div class="${skillBoxClass}"><div class="skill-box"><div><div class="skill-name">${sk.name||''}</div><div class="skill-power">${'<span class="power-icon"></span>'.repeat(sk.energy_cost||0)}</div></div><div class="skill-desc">${nl2br(sk.effect||'')}</div></div></div>`;
      });
      shrinkToFit(area); card.append(area);
      card.innerHTML+=`<div class="stats"><div class="atk">${labelAtk}: ${obj.attack||''}</div><div class="def">${labelDef}: ${obj.defence||''}</div></div>`;
      return card;
    }

    function shrinkToFit(el){
      let fs=parseFloat(getComputedStyle(el).fontSize);
      while(el.scrollHeight>el.clientHeight && fs>5){ fs-=0.5; el.style.fontSize=fs+'px'; }
    }

    // --- 数据与渲染 ---
    let prophecyHeader=[], monsterHeader=[], allProphecyRows=[], allMonsterRows=[];
    let displayCount=9;

    const getSortField=()=> (document.getElementById('sort-field')?.value || 'update_datetime');
    const getAltDisplay=()=> (document.getElementById('alt-display-toggle')?.checked ?? true);

    function sortRows(rows, header, field){
      const idx=header.indexOf(field); if(idx===-1) return rows.slice();
      return rows.slice().sort((a,b)=>{
        if(field==='update_datetime'){
          const aVal=a[idx]||'', bVal=b[idx]||'';
          const aDate=Date.parse(aVal), bDate=Date.parse(bVal);
          if(!isNaN(aDate)&&!isNaN(bDate)) return aDate-bDate;
          return aVal.localeCompare(bVal);
        }else{
          return (a[idx]||'').localeCompare(b[idx]||'');
        }
      });
    }

    async function renderAllCards(){
      const ctr=document.getElementById('card-container');
      ctr.innerHTML='';
      const sortField=getSortField(), altDisplay=getAltDisplay();
      const sortedProphecyRows=sortRows(allProphecyRows.slice(-displayCount), prophecyHeader, sortField);
      const sortedMonsterRows =sortRows(allMonsterRows.slice(-displayCount),  monsterHeader,  sortField);
      if(altDisplay){
        const maxLen=Math.max(sortedProphecyRows.length, sortedMonsterRows.length);
        for(let i=0;i<maxLen;i++){
          if(i<sortedMonsterRows.length)  ctr.append(createMonsterCard(mapCsvRowToObj(monsterHeader,  sortedMonsterRows[i])));
          if(i<sortedProphecyRows.length) ctr.append(createProphecyCard(mapCsvRowToObj(prophecyHeader, sortedProphecyRows[i])));
        }
      }else{
        for(let i=0;i<sortedMonsterRows.length;i++)  ctr.append(createMonsterCard(mapCsvRowToObj(monsterHeader,  sortedMonsterRows[i])));
        for(let i=0;i<sortedProphecyRows.length;i++) ctr.append(createProphecyCard(mapCsvRowToObj(prophecyHeader, sortedProphecyRows[i])));
      }
    }

    async function reloadCSVsAndRender(){
      let prophecy, monster; const ts=Date.now();
      if(lang==='en'){
        prophecy=await loadCSVWithHeader('prophecy_cards_en.csv?t='+ts);
        monster =await loadCSVWithHeader('monster_cards_en.csv?t='+ts);
      }else{
        prophecy=await loadCSVWithHeader('prophecy_cards.csv?t='+ts);
        monster =await loadCSVWithHeader('monster_cards.csv?t='+ts);
      }
      prophecyHeader=prophecy.headerArr; allProphecyRows=prophecy.rowsArr;
      monsterHeader =monster.headerArr;  allMonsterRows =monster.rowsArr;
      await renderAllCards();
    }

    function setLangClass(){ document.body.classList.toggle('en-mode', lang==='en'); }

    /* ---------- 打印流程（背景网格 + 固定排版） ---------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      reloadCSVsAndRender();
      setLangClass();

      document.getElementById('btn-refresh').onclick=reloadCSVsAndRender;

      const cardCountInput=document.getElementById('card-count');
      cardCountInput.onchange=function(){
        let val=parseInt(cardCountInput.value,10);
        if(isNaN(val)||val<1) val=1;
        displayCount=val;
        renderAllCards();
      };

      document.getElementById('btn-print').onclick=function(){
        // 进入打印布局
        document.getElementById('sidebar-panel').style.display='none';
        const main = document.getElementById('main-content');
        main.style.marginLeft='0';
        main.classList.add('fixed-print-width');
        document.getElementById('card-container').classList.add('grid-for-print');
        document.querySelectorAll('.card').forEach(c=>c.classList.add('card-print-size'));

        // 触发打印
        setTimeout(()=>{
          window.print();
          // 恢复
          setTimeout(()=>{
            document.getElementById('sidebar-panel').style.display='';
            main.style.marginLeft='240px';
            main.classList.remove('fixed-print-width');
            document.getElementById('card-container').classList.remove('grid-for-print');
            document.querySelectorAll('.card').forEach(c=>c.classList.remove('card-print-size'));
          }, 50);
        }, 30);
      };

      // Ctrl+P 直接打印时，自动套用/清理打印布局
      if('onbeforeprint' in window){
        window.addEventListener('beforeprint', ()=>{
          const main = document.getElementById('main-content');
          main.classList.add('fixed-print-width');
          document.getElementById('card-container').classList.add('grid-for-print');
          document.querySelectorAll('.card').forEach(c=>c.classList.add('card-print-size'));
        });
        window.addEventListener('afterprint', ()=>{
          const main = document.getElementById('main-content');
          main.classList.remove('fixed-print-width');
          document.getElementById('card-container').classList.remove('grid-for-print');
          document.querySelectorAll('.card').forEach(c=>c.classList.remove('card-print-size'));
        });
      }else if(window.matchMedia){
        const mq=window.matchMedia('print');
        if (mq.addEventListener) {
          mq.addEventListener('change', e=>{
            const main = document.getElementById('main-content');
            if(e.matches){
              main.classList.add('fixed-print-width');
              document.getElementById('card-container').classList.add('grid-for-print');
              document.querySelectorAll('.card').forEach(c=>c.classList.add('card-print-size'));
            }else{
              main.classList.remove('fixed-print-width');
              document.getElementById('card-container').classList.remove('grid-for-print');
              document.querySelectorAll('.card').forEach(c=>c.classList.remove('card-print-size'));
            }
          });
        } else if (mq.addListener) { // 旧浏览器
          mq.addListener(e=>{
            const main = document.getElementById('main-content');
            if(e.matches){
              main.classList.add('fixed-print-width');
              document.getElementById('card-container').classList.add('grid-for-print');
              document.querySelectorAll('.card').forEach(c=>c.classList.add('card-print-size'));
            }else{
              main.classList.remove('fixed-print-width');
              document.getElementById('card-container').classList.remove('grid-for-print');
              document.querySelectorAll('.card').forEach(c=>c.classList.remove('card-print-size'));
            }
          });
        }
      }

      // —— 语言切换（恢复） ——
      function updateLangSwitch(){
        const cn=document.getElementById('lang-cn');
        const en=document.getElementById('lang-en');
        if(!cn || !en) return;
        cn.classList.toggle('active', lang==='zh');
        en.classList.toggle('active', lang==='en');
      }
      updateLangSwitch();

      const cnBtn=document.getElementById('lang-cn');
      const enBtn=document.getElementById('lang-en');
      if(cnBtn) cnBtn.onclick=function(){
        if(lang!=='zh'){
          lang='zh';
          reloadCSVsAndRender();
          setLangClass();
          updateLangSwitch();
        }
      };
      if(enBtn) enBtn.onclick=function(){
        if(lang!=='en'){
          lang='en';
          reloadCSVsAndRender();
          setLangClass();
          updateLangSwitch();
        }
      };
    });
  </script>
</body>
</html>
