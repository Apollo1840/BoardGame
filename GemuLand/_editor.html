<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>卡牌编辑器（FS Access，无外链依赖）</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/css/bootstrap.min.css">
  <style>
    body { padding: 20px; background: #f7f7f7; }
    .card-table { max-height: 75vh; overflow: auto; }
    .modal.d-block { display: block; }
    .file-badge { font-size: 12px; }
  </style>
</head>
<body>
  <div class="container" id="app"></div>

  <script>
  'use strict';

  /************ 配置 & 状态 ************/
  const CONFIG = {
    prophecy: {
      defaultName: 'prophecy_cards.csv',
      header: ['card_title','introduction','effect','responsive_effect','image']
    },
    monster: {
      defaultName: 'monster_cards.csv',
  header: ['card_title','level','monster_type','description',
       'attack','defence','magic','attributes','skills','image']
    }
  };
  const DISPLAY = {
    prophecy: ['title','ename','intro','effect','responsive_effect'],
    monster : ['title','ename','level','monster_type','description','attack','defence', 'magic'] 
  };
  const LABELS = {
    title:'卡名',ename:'英文名',intro:'背景介绍',
    effect:'效果',responsive_effect:'响应效果',
    level:'等级',monster_type:'属性',
    description:'背景介绍',attack:'ATK',defence:'DEF',magic:'MAG'
  };
  const state = {
    current: 'prophecy',
    cards: { prophecy: [], monster: [] },
    handles: { prophecy: null, monster: null },
    filenames: { prophecy: '', monster: '' }
  };

  /************ 工具 ************/
  const $ = sel => document.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const isSecureContextOk = () => window.isSecureContext;

  function safeParse(str, def){ try{ return JSON.parse(str);}catch{ return def; } }
  function file2ename(p){
    if (!p) return '';
    return String(p).replace(/^pictures\//,'').replace(/\.(png|jpg|jpeg|gif)$/i,'');
  }
  function slugify(s){ return String(s||'').trim().replace(/\s+/g,'_').toLowerCase(); }
  function escapeHtml(s){
    return String(s??'').replace(/[&<>"']/g, m=>(
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  }
  function isHeaderRow(row, header){
    if (!Array.isArray(row) || row.length !== header.length) return false;
    for (let i=0;i<header.length;i++) if (row[i] !== header[i]) return false;
    return true;
  }

  /************ 轻量 CSV 解析（| 分隔 + 反斜杠转义） ************/
  // 规则：
  //  - 字段分隔符：|
  //  - 转义：\| 表示字面 '|'
  //  - 字面反斜杠：\\ -> '\'
  //  - 文本换行保存为字面 "\n"，读入时再还原成真实换行
  function parsePipeCsv(text){
    const lines = String(text||'').split(/\r?\n/).filter(l => l.length>0);
    return lines.map(line => {
      const out = [];
      let cur = '';
      for (let i=0; i<line.length; i++){
        const ch = line[i];
        if (ch === '\\') {
          const next = line[i+1];
          if (next === '|') { cur += '|'; i++; continue; }
          if (next === '\\') { cur += '\\'; i++; continue; }
          // 保留反斜杠本身（不吞掉）
          cur += '\\';
          continue;
        }
        if (ch === '|') { out.push(cur); cur=''; continue; }
        cur += ch;
      }
      out.push(cur);
      return out.map(decodeText);
    });
  }
  function encodeField(v){
    return String(v??'')
      .replace(/\|/g, '\\|')      // 转义分隔符
      .replace(/\r?\n/g, '\\n');  // 换行 -> 字面 \n
  }
  function decodeText(s){
    // 注意：顺序先还原 \|，再将 \n -> 换行
    return String(s??'').replace(/\\\|/g,'|').replace(/\\n/g,'\n');
  }

  /******** 行 ↔︎ 对象 ********/
  function rowToCard(type,row){
    if(type==='prophecy'){
      const [t,intro,effect,responsive_effect='',image] =
        row.length===4 ? [row[0],row[1],row[2],'',row[3]] : row;
      const title = decodeText(t || '');
      const enameFromTitle = title ? slugify(title) : '';
      const ename = file2ename(image) || enameFromTitle;
      return {
        title,
        ename,
        intro: decodeText(intro||''),
        effect: decodeText(effect||''),
        responsive_effect: decodeText(responsive_effect||''),
        image: image || (ename ? `pictures/${ename}.png` : '')
      };
    }
    // 10 columns: t,lvl,typ,desc,atk,def,magic,charStr,skillStr,image
    const [t,lvl,typ,desc,atk,def,magic,charStr,skillStr,image] = row;
    const title = decodeText(t || '');
    const enameFromTitle = title ? slugify(title) : '';
    const ename = file2ename(image) || enameFromTitle;
    // 修正：CSV 里用单引号包裹的 JSON 需转为双引号
    function fixJsonQuotes(str) {
      if (!str) return str;
      // 只在外层是单引号时替换
      if (str.trim().startsWith("'{") || str.trim().startsWith("'[") ) {
        // 去除外层单引号
        str = str.trim().replace(/^'/, '').replace(/'$/, '');
      }
      // 替换所有单引号为双引号（不在字符串内部的情况）
      // 更安全的做法是只替换键和字符串值的引号
      // 这里只做简单替换，假设没有嵌套单引号
      return str.replace(/'/g, '"');
    }
    let attributes = safeParse(fixJsonQuotes(String(charStr??'').replace(/\|/g,'|')), {});
    // Only accept normal_attribute and responsive_attribute
    let filteredAttrs = {};
    if (attributes.normal_attribute) filteredAttrs.normal_attribute = attributes.normal_attribute;
    if (attributes.responsive_attribute) filteredAttrs.responsive_attribute = attributes.responsive_attribute;
    return {
      title,
      ename,
      level: Number.isFinite(+lvl) ? +lvl : 0,
      monster_type: decodeText(typ || ''),
      description: decodeText(desc || ''),
      attack: Number.isFinite(+atk) ? +atk : 0,
      defence: Number.isFinite(+def) ? +def : 0,
      magic: isNaN(parseFloat(magic)) ? 0 : parseFloat(magic),
      attributes: filteredAttrs,
      skills:     safeParse(fixJsonQuotes(String(skillStr??'').replace(/\|/g,'|')), []),
      image: image || (ename ? `pictures/${ename}.png` : '')
    };
  }
  function cardToRow(type,c){
    const esc = v => encodeField(v);
    if (type==='prophecy'){
      return [esc(c.title), esc(c.intro), esc(c.effect), esc(c.responsive_effect), c.image];
    }
    // Only write normal_attribute and responsive_attribute
    let attrs = c.attributes || {};
    let outAttrs = {};
    if (attrs.normal_attribute) outAttrs.normal_attribute = attrs.normal_attribute;
    if (attrs.responsive_attribute) outAttrs.responsive_attribute = attrs.responsive_attribute;
    // skills: only keep name, energy_cost, effect
    let skillsArr = (c.skills||[]).map(s=>({
      name: s.name||'',
      energy_cost: Number.isFinite(+s.energy_cost)?+s.energy_cost:0,
      effect: s.effect||''
    }));
    return [
      esc(c.title),
      c.level,
      esc(c.monster_type),
      esc(c.description),
      c.attack,
      c.defence,
      c.magic,
      encodeField(JSON.stringify(outAttrs)),
      encodeField(JSON.stringify(skillsArr)),
      c.image
    ];
  }

  /******** File System Access：打开/保存 ********/
  async function pickOpenCsv(type){
    if (!isSecureContextOk()){
      alert('需要在 HTTPS 或 localhost 下使用 File System Access API');
      return;
    }
    try{
      const [handle] = await window.showOpenFilePicker({
        types: [{ description:'CSV', accept: { 'text/csv': ['.csv'] } }],
        excludeAcceptAllOption: false,
        multiple: false
      });
      state.handles[type] = handle;
      state.filenames[type] = handle.name || CONFIG[type].defaultName;
      const file = await handle.getFile();
      const text = await file.text();
      const rows = parsePipeCsv(text);
      // 新增：严格校验 header
      if (!rows.length || !isHeaderRow(rows[0], CONFIG[type].header)) {
        alert('文件头不匹配，可能不是正确的'+(type==='prophecy'?'预言':'怪兽')+'卡牌CSV文件！');
        state.handles[type] = null;
        state.filenames[type] = '';
        return;
      }
      rows.shift();
      state.cards[type] = rows.map(r=>rowToCard(type,r));
      render();
    }catch(e){
      if (e?.name !== 'AbortError') console.error('打开 CSV 失败：\n', e);
    }
  }

  async function pickSaveFile(type){
    const handle = await window.showSaveFilePicker({
      suggestedName: state.filenames[type] || CONFIG[type].defaultName,
      types: [{ description:'CSV', accept: { 'text/csv': ['.csv'] } }]
    });
    state.handles[type] = handle;
    state.filenames[type] = handle.name || CONFIG[type].defaultName;
    return handle;
  }

  function buildCsvTextFor(type){
    const rows = (state.cards[type]||[]).map(c=>cardToRow(type,c));
    rows.unshift(CONFIG[type].header);
    return rows.map(r=>r.join('|')).join('\n');
  }

  async function saveCsv(type, {saveAs=false} = {}){
    if (!isSecureContextOk()){
      alert('需要在 HTTPS 或 localhost 下使用 File System Access API');
      return;
    }
    try{
      let handle = state.handles[type];
      if (!handle || saveAs) handle = await pickSaveFile(type);
      const csv = buildCsvTextFor(type);
      const writable = await handle.createWritable();
      await writable.write(csv);
      await writable.close();
      toast('已写入：' + (state.filenames[type] || CONFIG[type].defaultName));
    }catch(e){
      if (e?.name !== 'AbortError') {
        console.error('保存失败：', e);
        alert('保存失败：' + (e?.message || e));
      }
    }
  }

  // 兜底：下载为本地文件（不写回原文件）
  function downloadCsv(type){
    const csv = buildCsvTextFor(type);
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = state.filenames[type] || CONFIG[type].defaultName;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  /******** 渲染 ********/
  function render(){
    $('#app').innerHTML = `
      <div class="d-flex align-items-center justify-content-between mb-3">
        <ul class="nav nav-tabs">
          <li class="nav-item"><a class="nav-link ${state.current==='prophecy'?'active':''}" role="button" data-tab="prophecy">预言卡牌</a></li>
          <li class="nav-item"><a class="nav-link ${state.current==='monster'?'active':''}"  role="button" data-tab="monster">怪兽卡牌</a></li>
        </ul>
        <div class="text-muted small">编辑页（File System Access）</div>
      </div>

      <div class="d-flex align-items-center gap-2 mb-2">
        <button id="btn-open"   class="btn btn-outline-secondary btn-sm">打开CSV（当前Tab）</button>
        <button id="btn-save"   class="btn btn-success btn-sm">保存（覆盖所选文件）</button>
        <button id="btn-saveas" class="btn btn-primary btn-sm">另存为</button>
        <button id="btn-export" class="btn btn-outline-primary btn-sm">导出下载（兜底）</button>
        <span class="badge bg-light text-dark file-badge">
          当前：${state.filenames[state.current] ? escapeHtml(state.filenames[state.current]) : '未绑定文件'}
        </span>
      </div>

      <div id="panel" class="bg-white p-3 rounded shadow-sm"></div>
    `;

    $$('[data-tab]').forEach(a=>{
      a.onclick = () => { state.current=a.dataset.tab; render(); };
    });

    $('#btn-open').onclick   = () => pickOpenCsv(state.current);
    $('#btn-save').onclick   = () => saveCsv(state.current, {saveAs:false});
    $('#btn-saveas').onclick = () => saveCsv(state.current, {saveAs:true});
    $('#btn-export').onclick = () => downloadCsv(state.current);

    renderTable();
  }

  function renderTable(){
    const type = state.current, list = state.cards[type] || [];
    const panel = $('#panel');
    if(!list.length){
      panel.innerHTML = `
        <div class="py-5 text-center text-muted">
          暂无数据。请点击“打开CSV（当前Tab）”选择文件，或“新增”创建卡牌后保存。
        </div>
        <div class="text-center">
          <button id="btn-add" class="btn btn-outline-primary">+ 新增</button>
        </div>`;
      $('#btn-add').onclick = ()=>openForm(null);
      return;
    }
    const keys = DISPLAY[type];
    let html = `
      <div class="card-table">
        <table class="table table-sm table-bordered align-middle">
          <thead><tr>
            ${keys.map(k=>`<th>${LABELS[k]}</th>`).join('')}
            <th style="width:120px;">操作</th>
          </tr></thead><tbody>`;

    list.forEach((c,i)=>{
      html += '<tr>';
      keys.forEach(k=> html+=`<td>${escapeHtml(c[k])}</td>`);
      html += `<td class="text-nowrap">
        <button class="btn btn-warning btn-sm me-1" data-edit="${i}">编辑</button>
        <button class="btn btn-danger  btn-sm" data-del="${i}">删</button>
      </td></tr>`;
    });
    html += '</tbody></table></div>';
    html += '<button id="btn-add" class="btn btn-outline-primary mt-2">+ 新增</button>';
    panel.innerHTML = html;

    $$('[data-edit]', panel).forEach(b=>b.onclick=()=>openForm(+b.dataset.edit));
    $$('[data-del]' , panel).forEach(b=>b.onclick=()=>{
      if(confirm('确定删除？')){ list.splice(+b.dataset.del,1); renderTable(); }
    });
    $('#btn-add').onclick = ()=>openForm(null);
  }

  /******** 表单弹窗（编辑/新增） ********/
  function openForm(idx){
    const type = state.current, list = state.cards[type];
    const editing = idx!==null;
    let card;
    if (editing) {
      card = JSON.parse(JSON.stringify(list[idx])); // 深拷贝
      // Ensure attributes and skills are always objects/arrays if present in CSV
      if(type==='monster') {
        if (!card.attributes || typeof card.attributes !== 'object') card.attributes = {};
        if (!Array.isArray(card.skills)) card.skills = [];
      }
    } else {
      card = createEmptyCard(type);
    }

    const modal = document.createElement('div');
    modal.className='modal d-block';
    modal.style.background='rgba(0,0,0,.45)';
    modal.innerHTML = `
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">${editing?'编辑':'新增'}${type==='prophecy'?'预言':'怪兽'}卡</h5>
            <button class="btn-close" data-close></button>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-close>取消</button>
            <button class="btn btn-primary"   data-save>保存</button>
          </div>
        </div>
      </div>`;
    document.body.append(modal);
    $$('[data-close]', modal).forEach(b=>b.onclick=()=>modal.remove());
    document.addEventListener('keydown', escClose);
    function escClose(e){ if(e.key==='Escape'){ modal.remove(); document.removeEventListener('keydown',escClose);} }

    const body = modal.querySelector('.modal-body');
    body.innerHTML = buildFormHtml(type,card);
    if(type==='monster') bindAttrSkillHandlers(body,card);

    modal.querySelector('[data-save]').onclick = () =>{
      collectForm(body,card,type);
      if(!card.title.trim()){ alert('卡名不能为空'); return; }
      if(!card.ename) card.ename = slugify(card.title);
      card.image = card.image || (card.ename ? `pictures/${card.ename}.png` : '');

      if(editing){
        const arr = state.cards[type].slice();
        // 关键：用下标删老卡，再 push 到末尾（保证“移动到最后”）
        arr.splice(idx, 1);
        arr.push(card);
        state.cards[type] = arr;
      }else{
        state.cards[type] = (state.cards[type]||[]).concat(card);
      }
      modal.remove(); renderTable();
    };
  }

  function createEmptyCard(t){
    return t==='prophecy'
      ? {title:'',ename:'',intro:'',effect:'',responsive_effect:'',image:''}
  : {title:'',ename:'',level:0,monster_type:'',
     description:'',attack:0,defence:0,
     attributes:{},skills:[],image:''};
  }

  function buildFormHtml(type,c){
    if(type==='prophecy'){
      return `
        <div class="mb-3">
          <label class="form-label">卡名</label>
          <input name="title" class="form-control" value="${escapeHtml(c.title)}">
        </div>
        <div class="mb-3">
          <label class="form-label">英文名</label>
          <input name="ename" class="form-control" value="${escapeHtml(c.ename)}">
        </div>
        <div class="mb-3">
          <label class="form-label">背景介绍</label>
          <textarea name="intro" rows="2" class="form-control">${escapeHtml(c.intro)}</textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">效果</label>
          <textarea name="effect" rows="3" class="form-control">${escapeHtml(c.effect)}</textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">响应效果（可选）</label>
          <textarea name="responsive_effect" rows="3" class="form-control">${escapeHtml(c.responsive_effect)}</textarea>
        </div>`;
    }
    return `
      <div class="row g-3">
        <!-- First row: three columns (等级, 卡名, 属性) -->
        <div class="col-md-3">
          <label class="form-label">等级</label>
          <input type="number" name="level" class="form-control" value="${c.level}">
        </div>
        <div class="col-md-6">
          <label class="form-label">卡名</label>
          <input name="title" class="form-control" value="${escapeHtml(c.title)}">
        </div>
        <div class="col-md-3">
          <label class="form-label">属性 (monster_type)</label>
          <input name="monster_type" class="form-control" value="${escapeHtml(c.monster_type)}">
        </div>

        <!-- Second row: one column (英文名) -->
        <div class="col-12">
          <label class="form-label">英文名</label>
          <input name="ename" class="form-control" value="${escapeHtml(c.ename)}">
        </div>

        <!-- Third row: background description -->
        <div class="col-12">
          <label class="form-label">背景介绍</label>
          <textarea name="description" rows="2" class="form-control">${escapeHtml(c.description)}</textarea>
        </div>
      </div>
      <div class="col-12"><hr>
      <h6>属性 attributes</h6>
        <div id="attr-container"></div>
        <button id="add-attr" class="btn btn-outline-secondary btn-sm mt-1" type="button">添加属性</button>
      </div>
      <div class="col-12"><hr>
        <h6>技能 skills</h6>
        <div id="skill-container"></div>
        <button id="add-skill" class="btn btn-outline-secondary btn-sm mt-1" type="button">添加技能</button>
      </div>
      <div class="row g-3 mt-2">
        <!-- Last row: three columns (攻击, 魔力, 防御) -->
        <div class="col-md-4">
          <label class="form-label">攻击</label>
          <input type="number" name="attack" class="form-control" value="${c.attack}">
        </div>
        <div class="col-md-4">
          <label class="form-label">魔力</label>
          <input type="text" inputmode="decimal" pattern="[0-9.]*" name="magic" class="form-control" value="${c.magic}">
        </div>
        <div class="col-md-4">
          <label class="form-label">防御</label>
          <input type="number" name="defence" class="form-control" value="${c.defence}">
        </div>
      </div>`;
  }

  function bindAttrSkillHandlers(container,card){
    const attrC  = container.querySelector('#attr-container');
    const skillC = container.querySelector('#skill-container');

    const attrHtml = (k,v)=>`
      <div class="d-flex align-items-center mb-1">
        <select class="form-select form-select-sm me-2 attr-key" style="max-width:140px;">
          <option value="normal_attribute" ${k==='normal_attribute'?'selected':''}>通常属性</option>
          <option value="responsive_attribute"  ${k==='responsive_attribute'?'selected':''}>响应属性</option>
        </select>
        <textarea class="form-control form-control-sm me-2 attr-val" rows="1">${escapeHtml(v)}</textarea>
        <button class="btn btn-sm btn-outline-danger" data-rm-attr="${k}" type="button">×</button>
      </div>`;

    const skillHtml = (i,s)=>`
      <div class="d-flex align-items-center mb-1 skill-row">
   <input class="form-control form-control-sm me-2 skill-name"
     placeholder="技能名" style="max-width:120px;" value="${escapeHtml(s.name||'')}">
   <input type="number" min="0" class="form-control form-control-sm me-2 skill-power"
     placeholder="灵力消耗" style="max-width:90px;" value="${Number.isFinite(+s.energy_cost)?+s.energy_cost:0}">
   <textarea class="form-control form-control-sm me-2 skill-text" rows="1"
        placeholder="描述">${escapeHtml(s.effect||'')}</textarea>
   <button class="btn btn-sm btn-outline-danger" data-rm-skill="${i}" type="button">×</button>
      </div>`;

    const renderAttrs = ()=>{
      attrC.innerHTML='';
      Object.entries(card.attributes).forEach(([k,v])=>{
        attrC.insertAdjacentHTML('beforeend',attrHtml(k,v));
      });
    };
    const renderSkills = ()=>{
      // Before re-render, save current edits from DOM to card.skills
      const rows = $$('#skill-container .skill-row', container);
      if (rows.length === card.skills.length) {
        rows.forEach((row, i) => {
          card.skills[i] = {
            name: row.querySelector('.skill-name').value.trim(),
            energy_cost: +row.querySelector('.skill-power').value || 0,
            effect: row.querySelector('.skill-text').value.trim()
          };
        });
      }
      skillC.innerHTML='';
      card.skills.forEach((s,i)=>skillC.insertAdjacentHTML('beforeend',skillHtml(i,s)));
    };

    attrC.addEventListener('click',e=>{
      if(e.target.dataset.rmAttr){ delete card.attributes[e.target.dataset.rmAttr]; renderAttrs(); }
    });
    skillC.addEventListener('click',e=>{
      if(e.target.dataset.rmSkill){ card.skills.splice(+e.target.dataset.rmSkill,1); renderSkills(); }
    });

    const ATTR_TYPES = ['normal_attribute','responsive_attribute'];
    container.querySelector('#add-attr').onclick = () =>{
      // Save current edits before adding
      const attrRows = $$('#attr-container .attr-key', container);
      attrRows.forEach((sel,i)=>{
        const val = $$('#attr-container .attr-val', container)[i].value.trim();
        if(sel.value && (sel.value==='normal_attribute'||sel.value==='responsive_attribute'))
          card.attributes[sel.value]=val;
      });
      const next = ATTR_TYPES.find(t=>!(t in card.attributes));
      if(!next){ alert('已添加全部可用属性'); return; }
      card.attributes[next]=''; renderAttrs();
    };
    container.querySelector('#add-skill').onclick = () =>{
      // Save current edits before adding
      const rows = $$('#skill-container .skill-row', container);
      if (rows.length === card.skills.length) {
        rows.forEach((row, i) => {
          card.skills[i] = {
            name: row.querySelector('.skill-name').value.trim(),
            energy_cost: +row.querySelector('.skill-power').value || 0,
            effect: row.querySelector('.skill-text').value.trim()
          };
        });
      }
      card.skills.push({name:'',energy_cost:0,effect:''}); renderSkills();
    };
    renderAttrs(); renderSkills();
  }

  function collectForm(body,card,type){
    const q = name=>body.querySelector(`[name="${name}"]`);
    if(type==='prophecy'){
      card.title             = q('title').value.trim();
      card.ename             = q('ename').value.trim();
      card.intro             = q('intro').value.trim();
      card.effect            = q('effect').value.trim();
      card.responsive_effect = q('responsive_effect').value.trim();
      return;
    }
    card.title        = q('title').value.trim();
    card.ename        = q('ename').value.trim();
    card.level        = +q('level').value || 0;
    card.monster_type = q('monster_type').value.trim();
    card.attack       = +q('attack').value || 0;
    card.defence      = +q('defence').value || 0;
    card.magic        = isNaN(parseFloat(q('magic').value)) ? 0 : parseFloat(q('magic').value);
    card.description  = q('description').value.trim();

    // Only allow normal_attribute and responsive_attribute as keys
    card.attributes = {};
    $$('#attr-container .attr-key', body).forEach((sel,i)=>{
      const val = $$('#attr-container .attr-val', body)[i].value.trim();
      if(val && (sel.value==='normal_attribute'||sel.value==='responsive_attribute'))
        card.attributes[sel.value]=val;
    });
    // skills: always save as array of {name, energy_cost, effect}
    card.skills = [];
    $$('#skill-container .skill-row', body).forEach(row=>{
      const name  = row.querySelector('.skill-name' ).value.trim();
      const power = +row.querySelector('.skill-power').value || 0;
      const text  = row.querySelector('.skill-text' ).value.trim();
      if(name||text) card.skills.push({name:name,energy_cost:power,effect:text});
    });
  }

  /******** 简易提示 ********/
  function toast(msg){
    const el = document.createElement('div');
    el.className = 'position-fixed top-0 start-50 translate-middle-x mt-3 alert alert-success shadow';
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 1600);
  }

  /******** 启动 ********/
  document.addEventListener('DOMContentLoaded', ()=>{
    render();

    // Ctrl+S / Cmd+S 快捷保存当前 Tab
    window.addEventListener('keydown', (e)=>{
      const isMac = navigator.platform.toUpperCase().includes('MAC');
      if ((isMac && e.metaKey && e.key.toLowerCase()==='s') ||
          (!isMac && e.ctrlKey && e.key.toLowerCase()==='s')) {
        e.preventDefault();
        saveCsv(state.current, {saveAs:false});
      }
    });
  });
  </script>
</body>
</html>
