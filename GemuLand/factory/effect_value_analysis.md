# 效果估值

## 基本估值： 

```python
DMG = 1 dmg = 0.2 （value）
# 一点伤害估值 0.2 
# 不使用dmg来做基本单位的原因是为了更好的锚定灵力

V = 0.2     # 战斗结算时的一点攻击力或防御力
MANA = 1    # 一点灵力估值为1

# 注意：以下价值没有对应行为
HC = 1     # 一张手牌估值为1
FC = 3     # 一张场牌估值为3

# 行为
AK = 1     # 一次攻击/技能/预言发动估值为1，即我方场上随机一只怪物或永续预言进行行动
```

## 基础公式： 

作用对方即为输出取负，即：
```python
-f(x) # 等于 当 f 行为 发生在对方时的价值估计
```

逆向增益可以转化为触发条件（响应法则），触发价值直接根据价值估计计算， 即
```python
-(1/p)*f(y) + g
# 等于 当 f 行为发生时，执行 g 行为的价值估计
# p 代表 f 发生概率矫正，概率矫正根据具体事件计算

q = -1/p # 正向触发系数

# 免疫公式
if p<1: - f(<-x) + f(>x)  = 0  

 # 下界估计公式
f(>=y) > f(y)  => -f(>y) < -f(y+1) 

```


## 具体估值
### 伤害行为


基本定义：
```python
DMG(x) = 0.2*x
-> DMG(-x) = -DMG(x)
-> DMG(a*x) = a*DMG(x)

# 例如：
DMG(5) = 1    # 给予对方5点伤害估值为 1
-DMG(-5) = 1  # 给予我方5点恢复估值为 1
DMG(10) = 2   # 给予对方10点伤害估值为 2
```

行为表：
| Explanation | Source  | Target | Target effect | Formula | 
|:------|:------------|:-----------|:------------|--------------:|
| 我方给予对方伤害 | 我方      | 对方 | 伤害  |  DMG(x) |
| 我方给予对方恢复 | 我方      | 对方 | 恢复  | DMG(-x) |
| 我方给予我方伤害 | 我方      | 我方 | 伤害  | -DMG(x) |
| 我方给予我方恢复 | 我方      | 我方 | 恢复  | -DMG(-x)|
| 对方给予我方伤害 | 对方      | 我方 | 伤害  | -DMG(x)|
| 对方给予我方恢复 | 对方      | 我方 | 恢复  | -DMG(-x)|
| 对方给予对方伤害 | 对方      | 对方 | 伤害  | DMG(x)|
| 对方给予对方恢复 | 对方      | 对方 | 恢复  | DMG(-x)|

- 不论来源


推论：
```python

# 并行
-DMG(5) + DMG(5) = 0
# 我方信仰-5, 对方信仰-5

# ---

# 正向触发
(-1)*DMG(5)-DMG(-5) = 0
# 当我方给对方造成5伤害时: 恢复5信仰 

# 触发条件修正
(-1)*DMG(>4)-DMG(-5) = 0
# 当我方给对方造成4以上伤害时: 恢复5信仰 

# ---

# 逆向触发
-DMG(5)-DMG(-5) = 0
# 当对方给我方造成5伤害时：恢复5信仰

# 触发条件修正 之 免疫公式
-DMG(>4)-DMG(<-4) = 0
# 当对方给我方造成4以上伤害时，免疫其伤害

-DMG(>4)-DMG(<-4)-DMG(-10)= 2 
# 当对方给予我方4以上伤害时，免疫其伤害，并我方得到10点恢复
```


高阶定义：
```python
DMG.A(x) = DMG(x*0.8) = 0.16*x
DMG.E(x) = DMG(x) = 0.2*x
1/p(DMG.A) = 1.1  # 对方主动给我方造成，或我方由于其他操作给对方造成
1/p(DMG.E) = 1.5  # 对方主动给我方造成，或我方由于其他操作给对方造成

# 例如：
DMG.A(6) = 0.96 ~ 1 
# 发动攻击，给予6点战斗伤害

DMG.A(13) = 2.08 ~ 2

-1.1*DMG.A(1) + DMG.A(7)  = 0.94 ~ 1
# 当我方给对方造成了战斗伤害，追加7点战斗伤害

-1.5*DMG.E(>1) + DMG.E(8)  = 1
# 当我方给对方造成了大于1点效果伤害，追加8点效果伤害
```

推论：
```python

# 当对方给我方造成了5以上战斗伤害时，恢复5信仰
-1.1*DMG.A(>5)-DMG(-5)
< -1.1*DMG.A(6)-DMG(-5) 
= 0.05 ~ 0

(-1)*1.1*DMG.A(6)+DMG(5) = 0.05 ~ 0
# 当我方给对方造成了5点战斗伤害时，对方信仰-5

-DMG.E(5) + DMG.A(6) = -0.04 ~ 0
# 我方信仰-5，某战斗伤害加6

-1.5*DMG.E(1) + DMG.A(2)= 0.02 ～ 0
# 当我方此回合受到效果伤害时，某战斗伤害加2

-1.1*DMG.A(>5) + DMG(5) = 0
# 当我方此回合受到5以上战斗伤害时，给予对方5伤害

```

高阶定义：
```python
DMG.E2() ~ -0.02 # 某次效果伤害翻倍
(-1)*1.5*DMG.E(>1) + DMG.E(3) = 0
(-1)*1.5*DMG.E(>3) + DMG.E(6) = 0
(-1)*1.5*DMG.E(>5) + DMG.E(9) = 0
(-1)*1.5*DMG.E(>7) + DMG.E(12) = 0

DMG.A2() ~ 0.01 # 某次战斗伤害翻倍
(-1)*1.1*DMG.A(>1) + DMG.E(2) ~ 0
(-1)*1.1*DMG.A(>3) + DMG.E(4) ~ 0
(-1)*1.1*DMG.A(>5) + DMG.E(6) ~ 0
(-1)*1.5*DMG.E(>7) + DMG.E(7) ~ 0

```



---

### 增强行为

基本定义：
```python
V_ATK(x) = V_DEF(x) = V(x) = 0.2*x
V(-x) = -V(x)

1/p(V) = 1.5      # 对方主动使用了增强

# 例如：
V_DEF(5) = V_ATK(5) = 1

V_ATK(10) = 2    
# 选择我方场上一只怪物，下次攻击攻击力+10

V_ATK(-10) = -2    
# 对方选择我方场上一只怪物攻击力-10

-V_DEF(10) = -2
# 对方选择对方场上一只怪物防御力+10

-V_DEF(-10) = 2
# 我方选择对方场上一只怪物防御力-10

```

推论：
```python
V_ATK(13) - 1.5*V_DEF(2) = 2 
# 当我方怪物攻击（防御力增加>1的）怪物时，该次攻击攻击力+13。

-V_ATK(-13) - 1.5*V_ATK(2) = 2  
# 当对方（攻击力增加>1的）怪物攻击我方怪物时，该次攻击攻击力-13。

```

行为表：
| Explanation | Source  | Target | Target effect | Formula | 
|:------|:------------|:-----------|:------------| --------------:|
| 我方选择一只怪物加点 | 我方     | 我方 | 加点  |  V(1, 1, x)  |
| 我方选择一只怪物扣点 | 我方     | 我方 | 扣点  |  V(1, 1, -x)  |
| 我方选择对方一只怪物加点 | 我方      | 对方 | 加点 | V(1, -1, x)|
| 我方选择对方一只怪物扣点 | 我方      | 对方 | 扣点 | V(1, -1, -x)|
| 对方选择我方一只怪物加点 | 对方     | 我方 | 加点 | V(-1, 1, x) |
| 对方选择我方一只怪物扣点 | 对方     | 我方 | 扣点 | V(-1, 1, -x) |
| 对方选择一只怪物加点 | 对方      | 对方 | 加点  | V(-1, -1, x) |
| 对方选择一只怪物扣点 | 对方      | 对方 | 扣点  | V(-1, -1, -x) |
| 我方随机获得加点 | -      | 我方 | 随机加点   | V.rand(x)|
| 对方随机获得加点  | -      | 对方 | 随机加点 | -V.rand(x) |
| 我方随机获得扣点 | -      | 我方 | 随机扣点   | V.rand(-x)|
| 对方随机获得扣点  | -     | 对方 | 随机扣点  | -V.rand(-x) |

高阶定义：
```python

V.rand(x) = V(0.75*x)

# 例如：
V_ATK.rand(7) = 1.05 ~ 1
# 我方场上随机一只怪物攻击力+7

-V_ATK.rand(-7) = 1.05 ~ 1
# 对方场上随机一只怪物攻击力+7

-V_DEF.rand(7) + V_ATK(5)  = 0
# 对方随机一只怪物防御力+7, 我方一只怪物下次攻击攻击力+5。

```

高阶定义：
$V = v_{0.2, 0.5}$ (吉姆价值博弈函数)

```python
# 我方选择我方场上一只怪物攻击力-10
V_ATK(1, 1, -10) = -1

# 我方转移5攻击力，信仰-2
V_ATK(1, 1, -5) + V_ATK(1, 1, 5) + DMG(-2) = 0.1 ~ 0

```

高阶定义：
```python
V_ATK.lock(x) = V_ATK(x)

# 例如：
V_ATK.lock(5) = 1
# 作用于永续预言卡，我方场上某一只怪物只要攻击，攻击力+5

V_ATK.lock(15) - V_DEF.lock(5) = 1
# 作用于永续预言卡，我方场上某一只怪物防御力-5, 只要攻击，攻击力+10
```
高阶定义：
```python
V_ATK2(.) = V_ATK(5)
# 攻击力+5 期望等于 攻击力翻倍
V_ATK3(.) = V_ATK(10)
```

高阶定义：
```python

V_ATK-ALL(x) = V_ATK(1.5*x)

V_ATK-ALL(3) = 0.9
# 我方所有怪物下次攻击攻击力+3
```


增强与增伤
```python

V_ATK(5) + DMG.A(6) = 2
# 我方一只怪物下次攻击攻击力+5, 造成的战斗伤害+6

V_ATK(5) + DMG.A2() = 2
# 我方一只怪物下次攻击攻击力+5, 造成的战斗伤害翻倍

V_ATK(5) + DMG.E2() = 2
# 我方一只怪物下次攻击攻击力+5, 战斗伤害追加同等效果伤害

```

### 御灵行为

基本定义：
```python
MANA(x) = x

1/p(MANA.has) = 2       # 拥有MANA, 预言卡调整
1/p(-MANA(x)) = 1.5     # 对方主动获得了MANA
1/p(MANA(-x)) = 1.5     # 对方主动使用了MANA
1/p(MANA) = 1.3         # 对方主动获得或使用了MANA


# 例如：
MANA(1) = 1
# 我方获得1点灵力（自由分配）

MANA(-1) = -1
# 对方消耗我方1点灵力

- MANA(1) = -1
# 对方获得1点灵力（自由分配）

- MANA(-1) = 1
# 我方消耗对方1点灵力

```

示例：
```python
MANA(2) = 2
# 我方获得2点灵力自由分配

- 1.5*MANA.use(>1) + MANA(3) = 0
# 当对方此回合使用了(>1)的灵力，我方获得3点灵力自由分配

MANA(-1) + MANA(1) = 0
# 对方选择我方一点灵力消除， 我方获得一点灵力

- MANA(1) + MANA(1) = 0
# 我方与对方都获得1点灵力（自由分配

（-1.5）* MANA(2) + MANA(3) = 0
# 我方此回合若使用了2灵力，我方获得3灵力自由分配

```

行为表：
| Explanation | Source  | Target | Target effect | Formula | 
|:------|:------------|:-----------|:------------| --------------:|
| 我方获得灵力| 我方     | 我方 | 获得  |  MANA(1, 1, x)  |
| 我方耗损灵力 | 我方     | 我方 | 耗损  |  MANA(1, 1, -x)  |
| 我方给予对方灵力 | 我方      | 对方 | 获得 | MANA(1, -1, x)|
| 我方耗损对方灵力 | 我方      | 对方 | 耗损 | MANA(1, -1, -x)|
| 对方给予我方灵力 | 对方     | 我方 | 获得 | MANA(-1, 1, x) |
| 对方耗损我方灵力 | 对方     | 我方 | 耗损 | MANA(-1, 1, -x) |
| 对方获得灵力 | 对方      | 对方 | 获得  | MANA(-1, -1, x) |
| 对方耗损灵力 | 对方      | 对方 | 耗损  | MANA(-1, -1, -x) |
| 我方随机获得灵力 | -      | 我方 | 随机获得   | MANA.rand(x)|
| 对方随机获得灵力  | -      | 对方 | 随机获得 | -MANA.rand(x) |
| 我方随机耗损灵力 | -      | 我方 | 随机耗损   | MANA.rand(-x)|
| 对方随机耗损灵力  | -     | 对方 | 随机耗损  | -MANA.rand(-x) |

高阶定义：
```python
MANA.rand(x) = 0.8*x

MANA.rand(4) - DMG(16) = 2
# 信仰-16, 随机获得4点灵力
```

高阶定义：

$\text{MANA} = v_{1, 0.5}$ (吉姆博弈价值函数)

```python
# 我方随意消除两点灵力
MANA(1, 1, -2) = -1

# 我方转移1灵力，信仰-2
MANA(1, 1, -1) + MANA(1, 1, 1) + DMG(-2) = 0.1 ~ 0

# 信仰-9, 我方获得3灵力，1个自己分配，1个对方分配，1个随机分配
DMG(-9) + MANA(1, 1, 1) + MANA(-1, 1, 1) + MANA.rand(1) = 0.5
```

高阶定义：
```python
MANA.lock(x) = 0.8*x

MANA(-4) + MANA.lock(5) = 0
# 将我方场上至多4点灵力汇聚到一张怪物上，其灵力额外+1

-DMG(8) + MANA.lock(2)  = 0
# 我方信仰-8, 场上一只怪物+2灵力

```

---

-（1）从卡堆随机获得一张手牌
-（-1）随机归置一张手牌
-（3）从卡堆随机使用一张场牌
-（-3）随机归置一张场牌
-（2）随机使用一张手牌
-（-2）随机收回一张场牌
- （1）一次额外攻击
- （1）一次技能刷新
- （2）一次效果回响
- （1）1点灵力（从卡堆顶部抽取）
- （0.5）查看对方一张手牌
- （0.2）查看卡堆顶

# Appendix

## 吉姆博弈价值函数

定义 $v_{p,q}(i, j, x)$:

$$
v(i, j, x) =
\begin{cases}
j \cdot \max(px, pqx) & i, j \text{ 同号} \\
j \cdot \min(px, pqx) & i, j \text{ 异号}
\end{cases}
$$

等价于:
$$
v(i, j, x) = j \cdot \max(px, pqx) \cdot \frac{1 + \text{sign}(ij)}{2} + j \cdot \min(px, pqx) \cdot \frac{1 - \text{sign}(ij)}{2}
$$


```python
# 推导性质：
- v(1, 1, x) = px if x > 0
- v(1, 1, x) = pqx if x < 0

- v(i, j, x)   =   -v(-i, j, -x)  # 单变
- v(i, j, -x)  =   v(i, -j, x)    # 单变
- v(i, j, x)   =   -v(-i, -j, x)  # 双变
- v(i, j, -x)  !=  -v(i, j, x)    # <--- IMPORTANT. 
# - (v(i, j, -x) - (-v(i, j, x)) = i(1-p)abs(x)
```

$i, j \in \{1, -1\}$ 代表玩家。

定义: 
- $v(x)=v(1, 1, x)$ when $x>0$.
- $v(x)=v(-1, 1, x)$ when  $x<0$.

可得：
```python
- v(x) = px
- v(-x) = -v(x)
```

解释：
$v(x)$ 代表 我方选择我方的对象获得某好处，或者 对方选择我方的对象获得某坏处。如此，价值的正负是线性的。
$p$ 代表这个好处或坏处的价值尺度。$p$通常在0到1之间。


当对象变得复杂时，我们使用 $v(i, j, x)$ 来衡量价值。

例如：
```python
v(1, -1, x)   # 代表我方选择对方的对象获得一项好处（或坏处）

v(1, 1, x)    # 代表我方选择我方的对象获得一项好处（或坏处）
= pqx if x<0  # 代表我方选择我方的对象获得一项坏处
```

$q$ 代表如果是坏处的话，我方通过具体的选择可以周转的难度。$q$通常在0到1之间。
