<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>卡牌编辑器</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    #editor { max-width: 1200px; margin: auto; }
    #tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    #tabs button { padding: 8px 16px; border: none; background: #ccc; cursor: pointer; border-radius: 4px; }
    #tabs button.active { background: #4a6cf7; color: #fff; }
    .panel { display: none; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 8px; text-align: left; }
    .btn { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; }
    .btn.edit { background: #f7a400; color: #fff; }
    .btn.delete { background: #f74a4a; color: #fff; }
    .btn.add { background: #4caf50; color: #fff; margin-bottom: 10px; }
    .form-container { background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; }
    .form-row { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
    .form-row label { width: 80px; }
    .form-row input, .form-row textarea, .form-row select { flex: 1; padding: 6px; }
    textarea { resize: vertical; }
    .sub-list { margin-left: 80px; margin-bottom: 10px; }
    .sub-list .item { display: flex; gap: 10px; align-items: start; margin-bottom: 5px; }
    .sub-list .item select, .sub-list .item input, .sub-list .item textarea { flex: 1; }
    #export { margin: 20px auto; display: block; }
    #output { width: 100%; height: 200px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>卡牌编辑器</h1>
  <div id="editor">
    <div id="tabs">
      <button id="tab-prophecy" class="active">预言卡牌</button>
      <button id="tab-monster">怪兽卡牌</button>
    </div>
    <!-- 预言卡面板 -->
    <div id="prophecy-panel" class="panel" style="display:block;">
      <button id="add-prophecy" class="btn add">添加新的预言卡</button>
      <div id="prophecy-list"></div>
      <div id="prophecy-form" class="form-container" style="display:none;"></div>
    </div>
    <!-- 怪兽卡面板 -->
    <div id="monster-panel" class="panel">
      <button id="add-monster" class="btn add">添加新的怪兽卡</button>
      <div id="monster-list"></div>
      <div id="monster-form" class="form-container" style="display:none;"></div>
    </div>
  </div>
  <button id="export" class="btn">导出当前卡牌为CSV</button>
  <textarea id="output" placeholder="CSV 内容将显示在此" readonly></textarea>
  <script>
    async function loadCSV(path) {
      const text = await (await fetch(path)).text();
      return text.split("\n").slice(1).filter(r=>r.trim());
    }
    function safeParse(str){ try{return JSON.parse(str);}catch{return [];} }

    let prophecyCards = [], monsterCards = [];

    /* 初始化 */
    async function init() {
      const p = await loadCSV('prophecy_cards.csv');
      prophecyCards = p.map(line=>{ const [title,intro,effect,image]=line.split('|'); return { title,intro,effect,image,ename:'' }; });
      updateProphecyList();
      const m = await loadCSV('monster_cards.csv');
      monsterCards = m.map(line=>{ const [title,level,type,desc,atk,def,charStr,skillStr,image]=line.split('|'); return { title,level,type,desc,atk,def,attributes:safeParse(charStr),skills:safeParse(skillStr),image,ename:'' }; });
      updateMonsterList();
    }

    /* 预言卡列表 */
    function updateProphecyList(){
      const c = document.getElementById('prophecy-list');
      let html='<table><thead><tr><th>卡名</th><th>背景介绍</th><th>效果</th><th>操作</th></tr></thead><tbody>';
      prophecyCards.forEach((cdi,i)=>{ html+=`<tr><td>${cdi.title}</td><td>${cdi.intro}</td><td>${cdi.effect}</td><td><button class="btn edit" onclick="openProphecyForm(${i})">编辑</button><button class="btn delete" onclick="deleteProphecy(${i})">删除</button></td></tr>`; });
      html+='</tbody></table>'; c.innerHTML=html;
    }
    function deleteProphecy(i){ prophecyCards.splice(i,1); updateProphecyList(); }

    function openProphecyForm(idx=null){
      const form=document.getElementById('prophecy-form'); form.innerHTML='';
      const rand4=(''+Math.floor(1000+Math.random()*9000));
      const card= idx!==null ? JSON.parse(JSON.stringify(prophecyCards[idx])) : {title:'新卡',ename:'new_card_'+rand4,intro:'',effect:'',image:''};
      form.innerHTML=`
        <div class="form-row"><label>卡名</label><input id="p-title" placeholder="卡名" value="${card.title}"/></div>
        <div class="form-row"><label>英文名</label><input id="p-ename" placeholder="英文名称" value="${card.ename}"/></div>
        <div class="form-row"><label>背景介绍</label><textarea id="p-intro" rows="2" placeholder="背景介绍">${card.intro}</textarea></div>
        <div class="form-row"><label>效果</label><textarea id="p-effect" rows="2" placeholder="效果">${card.effect}</textarea></div>
        <div class="form-row"><button class="btn add" id="p-save">保存</button><button class="btn" id="p-cancel">取消</button></div>
      `;
      form.style.display='block';
      document.getElementById('p-cancel').onclick=()=>{form.style.display='none';};
      document.getElementById('p-save').onclick=()=>{
        const ud={title:document.getElementById('p-title').value,ename:document.getElementById('p-ename').value,intro:document.getElementById('p-intro').value,effect:document.getElementById('p-effect').value};
        ud.image=`pictures/${ud.ename}.png`;
        if(idx!==null) prophecyCards[idx]=ud; else prophecyCards.push(ud);
        form.style.display='none'; updateProphecyList();
      };
    }

    /* 怪兽卡列表 */
    function updateMonsterList(){
      const c=document.getElementById('monster-list');
      let html='<table><thead><tr><th>卡名</th><th>等级</th><th>类型</th><th>背景介绍</th><th>ATK</th><th>DEF</th><th>操作</th></tr></thead><tbody>';
      monsterCards.forEach((m,i)=>{ html+=`<tr><td>${m.title}</td><td>${m.level}</td><td>${m.type}</td><td>${m.desc}</td><td>${m.atk}</td><td>${m.def}</td><td><button class="btn edit" onclick="openMonsterForm(${i})">编辑</button><button class="btn delete" onclick="deleteMonster(${i})">删除</button></td></tr>`; });
      html+='</tbody></table>'; c.innerHTML=html;
    }
    function deleteMonster(i){ monsterCards.splice(i,1); updateMonsterList(); }

    function openMonsterForm(idx=null){
      const form=document.getElementById('monster-form'); form.innerHTML='';
      const rand4=(''+Math.floor(1000+Math.random()*9000));
      const cd= idx!==null ? JSON.parse(JSON.stringify(monsterCards[idx])) : {title:'新卡',ename:'new_card_'+rand4,level:'0',type:'火',desc:'',atk:'0',def:'0',attributes:[],skills:[]};
      form.innerHTML=`
        <div class="form-row"><label>卡名</label><input id="m-title" placeholder="卡名" value="${cd.title}"/></div>
        <div class="form-row"><label>英文名</label><input id="m-ename" placeholder="英文名称" value="${cd.ename}"/></div>
        <div class="form-row"><label>等级</label><input id="m-level" type="number" min="0" placeholder="0" value="${cd.level}"/></div>
        <div class="form-row"><label>类型</label><input id="m-type" placeholder="火" value="${cd.type}"/></div>
        <div class="form-row"><label>背景介绍</label><textarea id="m-desc" rows="3" placeholder="背景介绍">${cd.desc}</textarea></div>
        <div class="form-row"><label>攻击</label><input id="m-atk" type="number" placeholder="0" value="${cd.atk}"/></div>
        <div class="form-row"><label>防御</label><input id="m-def" type="number" placeholder="0" value="${cd.def}"/></div>
        <hr />
        <div class="form-row"><label>属性</label><button class="btn add" id="add-attr">添加属性</button></div>
        <div id="attr-list" class="sub-list"></div>
        <hr />
        <div class="form-row"><label>技能</label><button class="btn add" id="add-skill">添加技能</button></div>
        <div id="skill-list" class="sub-list"></div>
        <div class="form-row"><button class="btn add" id="m-save">保存</button><button class="btn" id="m-cancel">取消</button></div>
      `;
      form.style.display='block';
      // 属性渲染
      const attrList=document.getElementById('attr-list');
      function renderAttrs(){ attrList.innerHTML=''; cd.attributes.forEach((at,i)=>{ const div=document.createElement('div'); div.className='item'; div.innerHTML=`<select class="attr-type"><option${at.attr_type==='通常属性'?' selected':''}>通常属性</option><option${at.attr_type==='响应属性'?' selected':''}>响应属性</option></select><textarea class="attr-content" rows="2" placeholder="内容">${at.content}</textarea><button class="btn delete">删除</button>`; div.querySelector('.delete').onclick=()=>{ cd.attributes.splice(i,1); renderAttrs(); }; attrList.append(div); }); }
      renderAttrs();
      document.getElementById('add-attr').onclick=()=>{ cd.attributes.push({attr_type:'通常属性',content:''}); renderAttrs(); };
      // 技能渲染
      const skillList=document.getElementById('skill-list');
      function renderSkills(){ skillList.innerHTML=''; cd.skills.forEach((sk,i)=>{ const div=document.createElement('div'); div.className='item'; div.innerHTML=`<input class="skill-name" placeholder="名称" value="${sk.skill_name}"/><input type="number" class="skill-power" placeholder="灵力消耗" value="${sk.number_power}" min="0"/><textarea class="skill-text" rows="2" placeholder="内容">${sk.skill_text}</textarea><button class="btn delete">删除</button>`; div.querySelector('.delete').onclick=()=>{ cd.skills.splice(i,1); renderSkills(); }; skillList.append(div); }); }
      renderSkills();
      document.getElementById('add-skill').onclick=()=>{ cd.skills.push({skill_name:'',number_power:0,skill_text:''}); renderSkills(); };
      // 保存/取消
      document.getElementById('m-cancel').onclick=()=>{ form.style.display='none'; };
      document.getElementById('m-save').onclick=()=>{
        const updated={ title:document.getElementById('m-title').value, ename:document.getElementById('m-ename').value, level:document.getElementById('m-level').value, type:document.getElementById('m-type').value, desc:document.getElementById('m-desc').value, atk:document.getElementById('m-atk').value, def:document.getElementById('m-def').value, attributes:[], skills:[] };
        // 收集属性
        attrList.querySelectorAll('.item').forEach(div=>{ updated.attributes.push({attr_type:div.querySelector('.attr-type').value, content:div.querySelector('.attr-content').value}); });
        // 收集技能
        skillList.querySelectorAll('.item').forEach(div=>{ updated.skills.push({ skill_name:div.querySelector('.skill-name').value, number_power:+div.querySelector('.skill-power').value, skill_text:div.querySelector('.skill-text').value }); });
        updated.image=`pictures/${updated.ename}.png`;
        if(idx!==null) monsterCards[idx]=updated; else monsterCards.push(updated);
        form.style.display='none'; updateMonsterList();
      };
    }

    // 标签切换
    document.getElementById('tab-prophecy').onclick=()=>{ document.getElementById('prophecy-panel').style.display='block'; document.getElementById('monster-panel').style.display='none'; document.getElementById('tab-prophecy').classList.add('active'); document.getElementById('tab-monster').classList.remove('active'); };
    document.getElementById('tab-monster').onclick=()=>{ document.getElementById('monster-panel').style.display='block'; document.getElementById('prophecy-panel').style.display='none'; document.getElementById('tab-monster').classList.add('active'); document.getElementById('tab-prophecy').classList.remove('active'); };
    // 绑定按钮
    document.getElementById('add-prophecy').onclick=()=>openProphecyForm(null);
    document.getElementById('add-monster').onclick=()=>openMonsterForm(null);
    document.getElementById('export').onclick=()=>{
      let text='card_title|introduction|effect|image\n'; prophecyCards.forEach(c=>{ text+=[c.title,c.intro,c.effect,c.image].join('|')+'\n'; }); text+='\ncard_title|level|monster_type|description|attack|defence|characters|skills|image\n'; monsterCards.forEach(c=>{ const chars=JSON.stringify(c.attributes); const skills=JSON.stringify(c.skills); text+=[c.title,c.level,c.type,c.desc,c.atk,c.def,chars,skills,c.image].join('|')+'\n'; }); document.getElementById('output').value=text;
    };
    init();
  </script>
</body>
</html>
