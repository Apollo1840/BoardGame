<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>卡牌编辑器</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    #editor { max-width: 1200px; margin: auto; }
    #tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    #tabs button { padding: 8px 16px; border: none; background: #ccc; cursor: pointer; border-radius: 4px; }
    #tabs button.active { background: #4a6cf7; color: #fff; }
    .panel { display: none; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 8px; text-align: left; }
    .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px; }
    .btn.edit { background: #f7a400; color: #fff; }
    .btn.delete { background: #f74a4a; color: #fff; }
    .btn.add { background: #4caf50; color: #fff; }
    .btn.save { background: #d32f2f; color: #fff; }
    .btn.saveas { background: #388e3c; color: #fff; }
    .form-container { background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; }
    .form-row { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
    .form-row label { width: 80px; }
    .form-row input, .form-row textarea, .form-row select { flex: 1; padding: 6px; }
    textarea { resize: vertical; }
    .sub-list { margin-left: 80px; margin-bottom: 10px; }
    .sub-list .item { display: flex; gap: 10px; align-items: start; margin-bottom: 5px; }
    .sub-list .item select, .sub-list .item input, .sub-list .item textarea { flex: 1; }
    #actions { text-align: center; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>卡牌编辑器</h1>
  <div id="editor">
    <div id="tabs">
      <button id="tab-prophecy" class="active">预言卡牌</button>
      <button id="tab-monster">怪兽卡牌</button>
    </div>
    <div id="prophecy-panel" class="panel" style="display:block;">
      <button id="add-prophecy" class="btn add">添加新的预言卡</button>
      <div id="prophecy-list"></div>
      <div id="prophecy-form" class="form-container" style="display:none;"></div>
    </div>
    <div id="monster-panel" class="panel">
      <button id="add-monster" class="btn add">添加新的怪兽卡</button>
      <div id="monster-list"></div>
      <div id="monster-form" class="form-container" style="display:none;"></div>
    </div>
  </div>
  <div id="actions">
    <button id="save" class="btn save">保存（覆盖当前 CSV）</button>
    <button id="saveas" class="btn saveas">另存为（下载 CSV）</button>
  </div>
  <script>
    async function loadCSV(path) {
      const text = await (await fetch(path)).text();
      return text.split("\n").slice(1).filter(r=>r.trim());
    }
    function safeParse(str){ try{return JSON.parse(str);}catch{return [];} }

    let prophecyCards = [], monsterCards = [];
    const prophecyPath = 'prophecy_cards.csv';
    const monsterPath = 'monster_cards.csv';

    async function init() {
      const p = await loadCSV(prophecyPath);
      prophecyCards = p.map(line => {
        const [title,intro,effect,image] = line.split('|');
        const ename = image.replace(/^pictures\//, '').replace(/\.png$/, '');
        return { title, ename, intro, effect, image };
      });
      updateProphecyList();

      const m = await loadCSV(monsterPath);
      monsterCards = m.map(line => {
        const [title,level,type,desc,atk,def,charStr,skillStr,image] = line.split('|');
        const ename = image.replace(/^pictures\//, '').replace(/\.png$/, '');
        return { title, ename, level, type, desc, atk, def,
                 attributes: safeParse(charStr), skills: safeParse(skillStr), image };
      });
      updateMonsterList();
    }

    function generateCSV(cards, type) {
      if (type === 'prophecy') {
        let text = 'card_title|introduction|effect|image\n';
        cards.forEach(c => text += [c.title, c.intro, c.effect, c.image].join('|') + '\n');
        return text;
      } else {
        let text = 'card_title|level|monster_type|description|attack|defence|characters|skills|image\n';
        cards.forEach(c => {
          const chars = JSON.stringify(c.attributes);
          const skills = JSON.stringify(c.skills);
          text += [c.title, c.level, c.type, c.desc, c.atk, c.def, chars, skills, c.image].join('|') + '\n';
        });
        return text;
      }
    }

    document.getElementById('save').onclick = async () => {
      const isProphecy = document.getElementById('prophecy-panel').style.display === 'block';
      const csv = generateCSV(isProphecy ? prophecyCards : monsterCards, isProphecy ? 'prophecy' : 'monster');
      const path = isProphecy ? prophecyPath : monsterPath;
      try {
        await fetch(path, { method: 'PUT', headers: {'Content-Type':'text/plain'}, body: csv });
        alert('已保存并覆盖：' + path);
      } catch (e) {
        alert('保存失败：' + e.message);
      }
    };

    document.getElementById('saveas').onclick = () => {
      const isProphecy = document.getElementById('prophecy-panel').style.display === 'block';
      const csv = generateCSV(isProphecy ? prophecyCards : monsterCards, isProphecy ? 'prophecy' : 'monster');
      const rand4 = '' + Math.floor(1000 + Math.random()*9000);
      const filename = (isProphecy ? 'prophecy_cards' : 'monster_cards') + '_' + rand4 + '.csv';
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    };

    function updateProphecyList() {
      const c = document.getElementById('prophecy-list');
      let html = '<table><thead><tr>' +
                 '<th>卡名</th><th>英文名</th><th>背景介绍</th><th>效果</th><th>操作</th>' +
                 '</tr></thead><tbody>';
      prophecyCards.forEach((cdi,i) => {
        html += `<tr><td>${cdi.title}</td><td>${cdi.ename}</td><td>${cdi.intro}</td><td>${cdi.effect}</td>` +
                `<td><button class="btn edit" onclick="openProphecyForm(${i})">编辑</button>` +
                `<button class="btn delete" onclick="deleteProphecy(${i})">删除</button></td></tr>`;
      });
      html += '</tbody></table>';
      c.innerHTML = html;
    }
    function deleteProphecy(idx) { prophecyCards.splice(idx,1); updateProphecyList(); }

    function openProphecyForm(idx = null) {
      const form = document.getElementById('prophecy-form'); form.innerHTML = '';
      const rand4 = '' + Math.floor(1000 + Math.random()*9000);
      const card = idx !== null ? JSON.parse(JSON.stringify(prophecyCards[idx]))
                                : { title:'新卡', ename:'new_card_'+rand4, intro:'', effect:'', image:'' };
      form.innerHTML = `
        <div class="form-row"><label>卡名</label><input id="p-title" value="${card.title}" placeholder="卡名"/></div>
        <div class="form-row"><label>英文名</label><input id="p-ename" value="${card.ename}" placeholder="英文名"/></div>
        <div class="form-row"><label>背景介绍</label><textarea id="p-intro" rows="2" placeholder="背景介绍">${card.intro}</textarea></div>
        <div class="form-row"><label>效果</label><textarea id="p-effect" rows="2" placeholder="效果">${card.effect}</textarea></div>
        <div class="form-row"><button class="btn add" id="p-save">保存</button><button class="btn" id="p-cancel">取消</button></div>
      `;
      form.style.display='block';
      document.getElementById('p-cancel').onclick = () => form.style.display='none';
      document.getElementById('p-save').onclick = () => {
        const ud = { title: document.getElementById('p-title').value, ename: document.getElementById('p-ename').value, intro: document.getElementById('p-intro').value, effect: document.getElementById('p-effect').value, image: '' };
        ud.image = `pictures/${ud.ename}.png`;
        if (idx !== null) prophecyCards[idx] = ud; else prophecyCards.push(ud);
        form.style.display='none'; updateProphecyList();
      };
    }

    function updateMonsterList() {
      const c = document.getElementById('monster-list');
      let html = '<table><thead><tr>' +
                 '<th>卡名</th><th>英文名</th><th>等级</th><th>类型</th><th>背景介绍</th><th>ATK</th><th>DEF</th><th>操作</th>' +
                 '</tr></thead><tbody>';
      monsterCards.forEach((m,i) => {
        html += `<tr><td>${m.title}</td><td>${m.ename}</td><td>${m.level}</td><td>${m.type}</td><td>${m.desc}</td><td>${m.atk}</td><td>${m.def}</td>` +
                `<td><button class="btn edit" onclick="openMonsterForm(${i})">编辑</button>` +
                `<button class="btn delete" onclick="deleteMonster(${i})">删除</button></td></tr>`;
      });
      html += '</tbody></table>';
      c.innerHTML = html;
    }
    function deleteMonster(idx) { monsterCards.splice(idx,1); updateMonsterList(); }

    function openMonsterForm(idx = null) {
      const form = document.getElementById('monster-form'); form.innerHTML = '';
      const rand4 = '' + Math.floor(1000 + Math.random()*9000);
      const card = idx !== null ? JSON.parse(JSON.stringify(monsterCards[idx]))
                                : { title:'新卡', ename:'new_card_'+rand4, level:'0', type:'火', desc:'', atk:'0', def:'0', attributes:[], skills:[] };
      form.innerHTML = `
        <div class="form-row"><label>卡名</label><input id="m-title" placeholder="卡名" value="${card.title}"/></div>
        <div class="form-row"><label>英文名</label><input id="m-ename" placeholder="英文名" value="${card.ename}"/></div>
        <div class="form-row"><label>等级</label><input id="m-level" type="number" min="0" placeholder="0" value="${card.level}"/></div>
        <div class="form-row"><label>类型</label><input id="m-type" placeholder="火" value="${card.type}"/></div>
        <div class="form-row"><label>背景介绍</label><textarea id="m-desc" rows="3" placeholder="背景介绍">${card.desc}</textarea></div>
        <div class="form-row"><label>攻击</label><input id="m-atk" type="number" placeholder="0" value="${card.atk}"/></div>
        <div class="form-row"><label>防御</label><input id="m-def" type="number" placeholder="0" value="${card.def}"/></div>
        <hr />
        <div class="form-row"><label>属性</label><button class="btn add" id="add-attr">添加属性</button></div>
        <div id="attr-list" class="sub-list"></div>
        <hr />
        <div class="form-row"><label>技能</label><button class="btn add" id="add-skill">添加技能</button></div>
        <div id="skill-list" class="sub-list"></div>
        <div class="form-row"><button class="btn add" id="m-save">保存</button><button class="btn" id="m-cancel">取消</button></div>
      `;
      form.style.display = 'block';
      const attrList = document.getElementById('attr-list');
      function renderAttrs() {
        attrList.innerHTML = '';
        card.attributes.forEach((at,i) => {
          const div = document.createElement('div'); div.className = 'item';
          div.innerHTML = `<select class="attr-type"><option${at.attr_type==='通常属性'?' selected':''}>通常属性</option><option${at.attr_type==='响应属性'?' selected':''}>响应属性</option></select><textarea class="attr-content" rows="2" placeholder="内容">${at.content}</textarea><button class="btn delete">删除</button>`;
          div.querySelector('.delete').onclick = () => { card.attributes.splice(i,1); renderAttrs(); };
          attrList.append(div);
        });
      }
      renderAttrs();
      document.getElementById('add-attr').onclick = () => { card.attributes.push({attr_type:'通常属性',content:''}); renderAttrs(); };
      const skillList = document.getElementById('skill-list');
      function renderSkills() {
        skillList.innerHTML = '';
        card.skills.forEach((sk,i) => {
          const div = document.createElement('div'); div.className = 'item';
          div.innerHTML = `<input class="skill-name" placeholder="名称" value="${sk.skill_name}"/><input type="number" class="skill-power" placeholder="灵力消耗" value="${sk.number_power}" min="0"/><textarea class="skill-text" rows="2" placeholder="内容">${sk.skill_text}</textarea><button class="btn delete">删除</button>`;
          div.querySelector('.delete').onclick = () => { card.skills.splice(i,1); renderSkills(); };
          skillList.append(div);
        });
      }
      renderSkills();
      document.getElementById('add-skill').onclick = () => { card.skills.push({skill_name:'',number_power:0,skill_text:''}); renderSkills(); };
      document.getElementById('m-cancel').onclick = () => { form.style.display = 'none'; };
      document.getElementById('m-save').onclick = () => {
        const updated = {
          title:document.getElementById('m-title').value,
          ename:document.getElementById('m-ename').value,
          level:document.getElementById('m-level').value,
          type:document.getElementById('m-type').value,
          desc:document.getElementById('m-desc').value,
          atk:document.getElementById('m-atk').value,
          def:document.getElementById('m-def').value,
          attributes:[], skills:[]
        };
        attrList.querySelectorAll('.item').forEach(div => {
          updated.attributes.push({attr_type:div.querySelector('.attr-type').value, content:div.querySelector('.attr-content').value});
        });
        skillList.querySelectorAll('.item').forEach(div => {
          updated.skills.push({ skill_name:div.querySelector('.skill-name').value, number_power:+div.querySelector('.skill-power').value, skill_text:div.querySelector('.skill-text').value });
        });
        updated.image = `pictures/${updated.ename}.png`;
        if (idx !== null) monsterCards[idx] = updated; else monsterCards.push(updated);
        form.style.display = 'none'; updateMonsterList();
      };
    }

    document.getElementById('tab-prophecy').onclick = () => { document.getElementById('prophecy-panel').style.display='block'; document.getElementById('monster-panel').style.display='none'; document.getElementById('tab-prophecy').classList.add('active'); document.getElementById('tab-monster').classList.remove('active'); };
    document.getElementById('tab-monster').onclick = () => { document.getElementById('monster-panel').style.display='block'; document.getElementById('prophecy-panel').style.display='none'; document.getElementById('tab-monster').classList.add('active'); document.getElementById('tab-prophecy').classList.remove('active'); };
    document.getElementById('add-prophecy').onclick = () => openProphecyForm(null);
    document.getElementById('add-monster').onclick = () => openMonsterForm(null);

    init();
  </script>
</body>
</html>
